<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/shan-logo-appletouch.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/shan-logo.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/shan-logo-16X16.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script class="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"blog.rosa.tw",root:"/",scheme:"Gemini",version:"8.0.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,"Pisces | Gemini":240},copycode:!0,bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!0,pangu:!1,comments:{style:"buttons",active:!0,storage:!0,lazyload:!0,nav:{disqus:{text:"ç•™è¨€å€",order:-1}},"Available values":"disqus"},motion:{enable:!1,async:!1,transition:{post_block:"fadeIn",post_header:"fadeInDown",post_body:"fadeInDown",coll_header:"fadeInLeft",sidebar:"fadeInUp"}},prism:!1,i18n:{placeholder:"æœå°‹...",empty:"We didn't find any results for the search: ${query}",hits_time:"${hits} results found in ${time} ms",hits:"${hits} results found"},path:"search.xml",localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1}}</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-S8ZEBJDRWG"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S8ZEBJDRWG")</script><meta name="description" content="æ–‡ç« ä¾†è‡ª : useEffect çš„å®Œæ•´æŒ‡å— â€” Overreacted  æ‘˜è¦  useEffect çš„åŸºç¤æ¦‚å¿µ useEffect dependencies array çš„ä½¿ç”¨æ–¹å¼  å¤§éƒ¨åˆ†éƒ½æ˜¯ä¾†è‡ªåŸæ–‡çš„å†ç¿»è­¯ï¼Œæˆ‘æœ‰äº›æ¯”è¼ƒä¸æ‡‚çš„éƒ¨åˆ†å°±ç”¨è‡ªå·±çš„æ–¹å¼å»è§£é‡‹ï¼Œä¹Ÿæœƒç”¨åŸå§‹çš„ JS å¯¦ä½œçš„æ–¹å¼ï¼Œè·Ÿè‘—ä¸€æ­¥æ­¥ç·¨è­¯ã€‚ æ›´é‡è¦çš„æ˜¯ï¼Œè¦ç”¨ React çš„æ€ç¶­ä¾†å»äº†è§£ useEffect çš„å…§æ¶µã€‚"><meta property="og:type" content="article"><meta property="og:title" content="ç­†è¨˜ | React - é‡æ–°äº†è§£ useEffect"><meta property="og:url" content="https://blog.rosa.tw/2022/08/React/react-useEffect-about-everythings"><meta property="og:site_name" content="å¥å¿˜é›œè¨˜"><meta property="og:description" content="æ–‡ç« ä¾†è‡ª : useEffect çš„å®Œæ•´æŒ‡å— â€” Overreacted  æ‘˜è¦  useEffect çš„åŸºç¤æ¦‚å¿µ useEffect dependencies array çš„ä½¿ç”¨æ–¹å¼  å¤§éƒ¨åˆ†éƒ½æ˜¯ä¾†è‡ªåŸæ–‡çš„å†ç¿»è­¯ï¼Œæˆ‘æœ‰äº›æ¯”è¼ƒä¸æ‡‚çš„éƒ¨åˆ†å°±ç”¨è‡ªå·±çš„æ–¹å¼å»è§£é‡‹ï¼Œä¹Ÿæœƒç”¨åŸå§‹çš„ JS å¯¦ä½œçš„æ–¹å¼ï¼Œè·Ÿè‘—ä¸€æ­¥æ­¥ç·¨è­¯ã€‚ æ›´é‡è¦çš„æ˜¯ï¼Œè¦ç”¨ React çš„æ€ç¶­ä¾†å»äº†è§£ useEffect çš„å…§æ¶µã€‚"><meta property="og:locale" content="zh_TW"><meta property="og:image" content="https://raw.githubusercontent.com/donavon/hook-flow/master/hook-flow.png"><meta property="og:image" content="https://redux.js.org/assets/images/ReduxDataFlowDiagram-49fa8c3968371d9ef6f2a1486bd40a26.gif"><meta property="og:image" content="https://i.imgur.com/cpFlaro.png"><meta property="og:image" content="https://i.imgur.com/Hh8l045.png"><meta property="article:published_time" content="2022-08-14T03:27:57.000Z"><meta property="article:modified_time" content="2022-08-14T15:28:46.954Z"><meta property="article:author" content="Rosa Hong"><meta property="article:tag" content="React"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://raw.githubusercontent.com/donavon/hook-flow/master/hook-flow.png"><link rel="canonical" href="https://blog.rosa.tw/2022/08/React/react-useEffect-about-everythings.html"><script class="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-TW"}</script><title>ç­†è¨˜ | React - é‡æ–°äº†è§£ useEffect | å¥å¿˜é›œè¨˜</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-S8ZEBJDRWG"></script><script>if(CONFIG.hostname===location.hostname){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S8ZEBJDRWG")}</script><noscript><style>body{margin-top:2rem}.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .sidebar{visibility:visible}.use-motion .footer,.use-motion .header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript><link rel="alternate" href="/atom.xml" title="å¥å¿˜é›œè¨˜" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="åˆ‡æ›å°èˆªæ¬„"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">å¥å¿˜é›œè¨˜</h1><i class="logo-line"></i></a><p class="site-subtitle" itemprop="description">ç´€éŒ„å­¸ç¿’èˆ‡ç”Ÿæ´»</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> é¦–é </a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> æ¨™ç±¤<span class="badge">27</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> åˆ†é¡<span class="badge">18</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> æ­¸æª”<span class="badge">58</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> æœå°‹</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" maxlength="80" placeholder="æœå°‹..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div class="search-result-container no-result"><div class="search-result-icon"><i class="fa fa-spinner fa-pulse fa-5x"></i></div></div></div></div></div><div class="toggle sidebar-toggle"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> æ–‡ç« ç›®éŒ„</li><li class="sidebar-nav-overview"> æœ¬ç«™æ¦‚è¦</li></ul><section class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%91%98%E8%A6%81-10"><span class="nav-number">1.</span> <span class="nav-text">æ‘˜è¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#React-%E7%9A%84%E6%B8%B2%E6%9F%93%E6%A9%9F%E5%88%B6"><span class="nav-number">2.</span> <span class="nav-text">React çš„æ¸²æŸ“æ©Ÿåˆ¶</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#render-function-%E5%85%A7%E7%9A%84-function"><span class="nav-number">3.</span> <span class="nav-text">render function å…§çš„ function ?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#function-%E5%85%A7%E9%83%A8%E6%89%80%E5%BC%95%E7%94%A8%E7%9A%84-state-%E9%97%9C%E4%BF%82"><span class="nav-number">3.1.</span> <span class="nav-text">function å…§éƒ¨æ‰€å¼•ç”¨çš„ state é—œä¿‚</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E9%A0%AD%E7%9C%8B-React-%E7%9A%84-render-%E5%85%A7%E9%83%A8%E7%9A%84-function"><span class="nav-number">3.2.</span> <span class="nav-text">å›é ­çœ‹ React çš„ render å…§éƒ¨çš„ function</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AF%8F%E4%B8%80%E6%AC%A1-render-%E9%83%BD%E5%AE%83%E8%87%AA%E5%B7%B1%E7%9A%84-Effect"><span class="nav-number">4.</span> <span class="nav-text">æ¯ä¸€æ¬¡ render éƒ½å®ƒè‡ªå·±çš„ Effect</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AF%8F%E4%B8%80%E6%AC%A1-render-%E4%BF%9D%E6%9C%89%E5%AE%83%E7%9A%84%E6%89%80%E6%9C%89%E6%9D%B1%E8%A5%BF"><span class="nav-number">5.</span> <span class="nav-text">æ¯ä¸€æ¬¡ render ä¿æœ‰å®ƒçš„æ‰€æœ‰æ±è¥¿</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%9F-class-Component-%E7%9A%84%E5%B7%AE%E5%88%A5"><span class="nav-number">5.1.</span> <span class="nav-text">è·Ÿ class Component çš„å·®åˆ¥</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E6%8B%BF%E5%8F%96%E6%9C%80%E6%96%B0%E7%9A%84-state"><span class="nav-number">6.</span> <span class="nav-text">å¦‚ä½•æ‹¿å–æœ€æ–°çš„ state ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-ref-%E4%BE%86%E5%8F%96%E5%BE%97%E6%9C%80%E6%96%B0%E5%80%BC"><span class="nav-number">7.</span> <span class="nav-text">ä½¿ç”¨ ref ä¾†å–å¾—æœ€æ–°å€¼</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AB%87%E8%AB%87-clean-up"><span class="nav-number">8.</span> <span class="nav-text">è«‡è«‡ clean up</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5%E5%9F%B7%E8%A1%8C%E4%BD%86%E4%B8%8D%E6%98%AF%E7%94%9F%E5%91%BD%E9%80%B1%E6%9C%9F"><span class="nav-number">9.</span> <span class="nav-text">åŒæ­¥åŸ·è¡Œä½†ä¸æ˜¯ç”Ÿå‘½é€±æœŸ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%91%8A%E8%A8%B4-React-%E4%B8%8D%E5%90%8C-effect-%E4%B9%8B%E9%96%93%E7%9A%84%E5%B7%AE%E5%88%A5"><span class="nav-number">10.</span> <span class="nav-text">å‘Šè¨´ React ä¸åŒ effect ä¹‹é–“çš„å·®åˆ¥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E8%A6%81%E5%B0%8D-dependencies-%E8%AA%AA%E8%AC%8A"><span class="nav-number">11.</span> <span class="nav-text">ä¸è¦å° dependencies èªªè¬Š</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#dependencies-%E8%AA%AA%E8%AC%8A%E4%BA%86%E6%9C%83%E7%99%BC%E7%94%9F%E4%BB%80%E9%BA%BC%E5%95%8F%E9%A1%8C"><span class="nav-number">11.1.</span> <span class="nav-text">dependencies èªªè¬Šäº†æœƒç™¼ç”Ÿä»€éº¼å•é¡Œ ?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AA%A0%E5%AF%A6%E4%BB%A5%E5%B0%8D-dependencies%EF%BC%8C%E6%8A%8A%E6%9C%89%E9%97%9C%E7%9A%84%E6%94%BE%E5%85%A5-array-%E4%B8%AD"><span class="nav-number">11.2.</span> <span class="nav-text">èª å¯¦ä»¥å° dependenciesï¼ŒæŠŠæœ‰é—œçš„æ”¾å…¥ array ä¸­</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%89%E6%95%88%E7%8E%87%E7%9A%84%E4%BD%BF%E7%94%A8-useEffect"><span class="nav-number">12.</span> <span class="nav-text">æœ‰æ•ˆç‡çš„ä½¿ç”¨ useEffect</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A9%A6%E8%91%97%E6%8B%86%E8%A7%A3%E4%B8%A6%E4%BA%86%E8%A7%A3"><span class="nav-number">12.1.</span> <span class="nav-text">è©¦è‘—æ‹†è§£ä¸¦äº†è§£</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BE%9E-Google-%E6%96%87%E4%BB%B6%E7%9A%84%E6%9B%B4%E6%96%B0%E4%BA%86%E8%A7%A3-function-updater"><span class="nav-number">13.</span> <span class="nav-text">å¾ Google æ–‡ä»¶çš„æ›´æ–°äº†è§£ function updater</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%87%E8%B3%87%E6%96%99%E6%9B%B4%E6%96%B0%E8%88%87%E6%93%8D%E4%BD%9C%E5%88%86%E9%9B%A2"><span class="nav-number">14.</span> <span class="nav-text">å°‡è³‡æ–™æ›´æ–°èˆ‡æ“ä½œåˆ†é›¢</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E9%A9%97-%E5%88%86%E9%96%8B%E7%9A%84%E5%85%A9%E7%AD%86%E8%B3%87%E6%96%99%E6%9B%B4%E6%96%B0"><span class="nav-number">14.1.</span> <span class="nav-text">å¯¦é©— : åˆ†é–‹çš„å…©ç­†è³‡æ–™æ›´æ–°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E9%A9%97-%E5%86%8D%E6%9F%90%E7%AD%86%E8%B3%87%E6%96%99%E5%85%A7%E9%83%A8%E6%8B%BF%E5%88%B0%E6%9C%80%E6%96%B0"><span class="nav-number">14.2.</span> <span class="nav-text">å¯¦é©— : å†æŸç­†è³‡æ–™å…§éƒ¨æ‹¿åˆ°æœ€æ–°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E9%A9%97-object-type-%E7%9A%84-state"><span class="nav-number">14.3.</span> <span class="nav-text">å¯¦é©— : object type çš„ state</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%A6%E9%A9%97-%E6%8A%8A-input-%E8%AE%8A%E6%88%90-uncontrolled-component"><span class="nav-number">14.4.</span> <span class="nav-text">å¯¦é©— : æŠŠ input è®Šæˆ uncontrolled component</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9E%E5%88%B0-useReducer"><span class="nav-number">15.</span> <span class="nav-text">å›åˆ° useReducer</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%82%BA%E4%BB%80%E9%BA%BC-useReducer-%E6%98%AF-Hooks-%E7%9A%84%E4%BD%9C%E5%BC%8A%E6%96%B9%E5%BC%8F"><span class="nav-number">16.</span> <span class="nav-text">ç‚ºä»€éº¼ useReducer æ˜¯ Hooks çš„ä½œå¼Šæ–¹å¼ ?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%99%BD%E8%A9%B1%E7%BF%BB%E8%AD%AF%E6%A9%9F"><span class="nav-number">16.1.</span> <span class="nav-text">ç™½è©±ç¿»è­¯æ©Ÿ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%BA%E9%AB%94%E7%B7%A8%E8%AD%AF"><span class="nav-number">16.2.</span> <span class="nav-text">äººé«”ç·¨è­¯</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%8A-function-%E7%A7%BB%E5%88%B0-useEffect-%E4%B8%AD"><span class="nav-number">17.</span> <span class="nav-text">æŠŠ function ç§»åˆ° useEffect ä¸­</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E8%83%BD%E6%8A%8A-function-%E7%A7%BB%E5%85%A5-useEffect-%E6%80%8E%E9%BA%BC%E8%BE%A6"><span class="nav-number">18.</span> <span class="nav-text">ä¸èƒ½æŠŠ function ç§»å…¥ useEffect æ€éº¼è¾¦ ?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#function-%E6%98%AF%E8%B3%87%E6%96%99%E6%B5%81%E7%9A%84%E4%B8%80%E7%A8%AE%E5%97%8E"><span class="nav-number">19.</span> <span class="nav-text">function æ˜¯è³‡æ–™æµçš„ä¸€ç¨®å— ?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F-4"><span class="nav-number">19.1.</span> <span class="nav-text">æ³¨æ„</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AB%87%E8%AB%87%E7%AB%B6%E7%88%AD%E6%A2%9D%E4%BB%B6-race-condition"><span class="nav-number">20.</span> <span class="nav-text">è«‡è«‡ç«¶çˆ­æ¢ä»¶ (race condition)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%94%A8%E6%AD%A3%E7%A2%BA%E7%9A%84%E5%BF%83%E6%85%8B%E5%B0%8D%E5%BE%85-useEffect"><span class="nav-number">21.</span> <span class="nav-text">ç”¨æ­£ç¢ºçš„å¿ƒæ…‹å°å¾… useEffect</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B8%BD%E7%B5%90-33"><span class="nav-number">22.</span> <span class="nav-text">ç¸½çµ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%8C%E5%A4%96%E8%A9%B1"><span class="nav-number">22.1.</span> <span class="nav-text">é¡Œå¤–è©±</span></a></li></ol></li></ol></div></section><section class="site-overview-wrap sidebar-panel"><div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Rosa Hong" src="/images/RosaBlog-LOGO.png"><p class="site-author-name" itemprop="name">Rosa Hong</p><div class="site-description" itemprop="description">èœé³¥èµ·é£›ä¸­</div></div><div class="site-state-wrap animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">58</span> <span class="site-state-item-name">æ–‡ç« </span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">18</span> <span class="site-state-item-name">åˆ†é¡</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">27</span> <span class="site-state-item-name">æ¨™ç±¤</span></a></div></nav></div><div class="links-of-author animated"><span class="links-of-author-item"><a href="https://github.com/meitung473" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;meitung473" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a></span><span class="links-of-author-item"><a href="mailto:a8870506@gmail.com" title="è¯çµ¡æˆ‘ â†’ mailto:a8870506@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a></span><span class="links-of-author-item"><a href="https://www.facebook.com/yanshan.hong1" title="Rosa Hong â†’ https:&#x2F;&#x2F;www.facebook.com&#x2F;yanshan.hong1" rel="noopener" target="_blank"><i class="fa fa-facebook fa-fw"></i></a></span></div></section></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><div class="reading-progress-bar"></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW"><link itemprop="mainEntityOfPage" href="https://blog.rosa.tw/2022/08/React/react-useEffect-about-everythings"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/RosaBlog-LOGO.png"><meta itemprop="name" content="Rosa Hong"><meta itemprop="description" content="èœé³¥èµ·é£›ä¸­"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="å¥å¿˜é›œè¨˜"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> ç­†è¨˜ | React - é‡æ–°äº†è§£ useEffect</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">ç™¼è¡¨æ–¼</span> <time title="å‰µå»ºæ™‚é–“ï¼š2022-08-14 11:27:57" itemprop="dateCreated datePublished" datetime="2022-08-14T11:27:57+08:00">2022-08-14</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">åˆ†é¡æ–¼</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Front-end/" itemprop="url" rel="index"><span itemprop="name">Front-end</span></a></span> ï¼Œ <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Front-end/React/" itemprop="url" rel="index"><span itemprop="name">React</span></a></span></span></div><div class="post-meta"><span class="post-meta-item" title="æ–‡ç« å­—æ•¸"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">æ–‡ç« å­—æ•¸ï¼š</span> <span>39k</span></span><span class="post-meta-item" title="æ‰€éœ€é–±è®€æ™‚é–“"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">æ‰€éœ€é–±è®€æ™‚é–“ &asymp;</span> <span>35 åˆ†é˜</span></span></div></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>æ–‡ç« ä¾†è‡ª : <a href="https://overreacted.io/zh-hant/a-complete-guide-to-useeffect/">useEffect çš„å®Œæ•´æŒ‡å— â€” Overreacted</a></p></blockquote><h2 id="æ‘˜è¦-10">æ‘˜è¦</h2><ol><li>useEffect çš„åŸºç¤æ¦‚å¿µ</li><li>useEffect dependencies array çš„ä½¿ç”¨æ–¹å¼</li></ol><p>å¤§éƒ¨åˆ†éƒ½æ˜¯ä¾†è‡ªåŸæ–‡çš„å†ç¿»è­¯ï¼Œæˆ‘æœ‰äº›æ¯”è¼ƒä¸æ‡‚çš„éƒ¨åˆ†å°±ç”¨è‡ªå·±çš„æ–¹å¼å»è§£é‡‹ï¼Œä¹Ÿæœƒç”¨åŸå§‹çš„ JS å¯¦ä½œçš„æ–¹å¼ï¼Œè·Ÿè‘—ä¸€æ­¥æ­¥ç·¨è­¯ã€‚</p><p>æ›´é‡è¦çš„æ˜¯ï¼Œè¦ç”¨ React çš„æ€ç¶­ä¾†å»äº†è§£ <code>useEffect</code> çš„å…§æ¶µã€‚</p><span id="more"></span><h2 id="React-çš„æ¸²æŸ“æ©Ÿåˆ¶">React çš„æ¸²æŸ“æ©Ÿåˆ¶</h2><p>äº†è§£ useEffect ä¹‹å‰ï¼Œå…ˆä¾†äº†è§£ <code>setState</code> çš„æ™‚å€™æœƒç™¼ç”Ÿä»€éº¼äº‹ã€‚<br> ç•¶æˆ‘å€‘ <code>setState</code> æ™‚ï¼ŒReact æœƒé‡æ–°å‘¼å« Component functionï¼Œä¸¦æ›´æ–°å…¶å€¼ï¼Œæ¥è‘—<br> React æŠŠæˆ‘å€‘æœ€æ–°çš„å€¼æ›´æ–°åˆ° DOM ä¸Šã€‚</p><p>è€Œ <code>useEffect</code> åŸ·è¡Œçš„æ™‚é–“é»åœ¨ render ä¹‹å¾Œï¼Œç‚ºä»€éº¼ <code>useEffect</code> æœƒæ‹¿åˆ°èˆŠçš„ state è·Ÿ props ?</p><blockquote><p>æ¯ä¸€æ¬¡éƒ½æ¸²æŸ“éƒ½ä¿æœ‰è‡ªå·±çš„ state è·Ÿ props</p></blockquote><p>æˆ‘å€‘è©¦è‘—æŠŠæ¯æ¬¡ render æ‹†é–‹ä¾†</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// useState </span></span><br><span class="line"><span class="keyword">const</span> [count,setCount] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬ 1 æ¬¡ render æ˜¯é€™æ¨£</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> count = <span class="number">0</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ç¬¬ 2 æ¬¡ render</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>)&#123;</span><br><span class="line">  <span class="keyword">const</span> count = <span class="number">1</span></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡ render é‡æ–°å‘¼å« <code>Counter()</code> ï¼ŒæŠŠ count æ¯æ¬¡é‡æ–°è³¦å€¼ï¼Œæ¯æ¬¡ render state éƒ½æœƒæ˜¯ç¨ç«‹çš„ã€‚</p><p>ä»€éº¼æ„æ€å‘¢ï¼ŸğŸ¤” å°±æ˜¯ä½ åœ¨ä¸€å‘¨ç›®çœ‹åˆ°çš„è³‡æ–™ï¼Œæ—¢ç„¶ä½ åœ¨ä¸€å‘¨ç›®å–è³‡æ–™ï¼Œé‚£ä¹Ÿåªæœƒæ‹¿åˆ°ä¸€å‘¨ç›®çš„è³‡æ–™ã€‚ä¸¦ä¸èƒ½ç›´æ¥å–äºŒã€ä¸‰å‘¨ç›®çš„æ±è¥¿ã€‚</p><p><code>useEffect</code> é›–ç„¶æ˜¯æ¸²æŸ“å¾ŒåŸ·è¡Œçš„ï¼Œä½†ä»–å…¶å¯¦é‚„æ˜¯å¾…åœ¨åŒä¸€å€‹æ™‚é–“ç·šçš„æ¸²æŸ“ (ä¹Ÿå°±æ˜¯åŒæ­¥çš„)ï¼Œä¸¦ä¸æ˜¯çœŸæ­£æ„å‘³ä¸Šçš„ã€Œæ¸²æŸ“ <strong>å¾Œ</strong>ã€ï¼Œåˆ¥è¢«æ–‡å­—ææ··äº†ã€‚</p><h2 id="render-function-å…§çš„-function">render function å…§çš„ function ?</h2><p>æ–‡ä¸­<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>ç¯„ä¾‹é †åºæ˜¯</p><ol><li>æŠŠ state åŠ åˆ° 3</li><li>æŒ‰ä¸‹ <code>alert</code> æŒ‰éµ ( <code>setTimeout</code> for<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">3</span></span></span></span> seconds , and é¡¯ç¤º state )</li><li>é¦¬ä¸ŠæŠŠ state åŠ åˆ° 5ï¼Œæœ€å¾Œé¡¯ç¤ºæ˜¯ ?</li></ol><blockquote><p>çµæœæ˜¯<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">3</span></span></span></span> ï¼Œé€™è£¡æ˜¯æŠ“åˆ° (capture) æŒ‰ä¸‹æŒ‰éˆ•çš„ <strong>ç•¶ä¸‹</strong></p></blockquote><p>å¯ä»¥æƒ³åƒæˆèŠå¤© app ï¼Œè·Ÿ A èŠå¤©é€å‡ºè¨Šæ¯ï¼Œæ¥è‘—é¦¬ä¸Šåˆ‡æ›è·Ÿ B è¼¸å…¥è¨Šæ¯ï¼Œç¢ºå¯¦æ˜¯ A æ”¶åˆ°è¨Šæ¯ï¼Œä¸¦ä¸æ˜¯ B æ”¶åˆ°ã€‚<br> åœ¨ class Component è·Ÿ functional Component å…©ç¨®è§£æ±ºä¸åŒçš„å•é¡Œ (é–‰åŒ…)</p><h3 id="function-å…§éƒ¨æ‰€å¼•ç”¨çš„-state-é—œä¿‚">function å…§éƒ¨æ‰€å¼•ç”¨çš„ state é—œä¿‚</h3><p>å¾æœ€æ ¹æœ¬çš„ JavaScript ä¾†çœ‹ï¼Œä¾‹å­æ˜¯å¾æ–‡ç« ä¾†çš„</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">sayHi</span>(<span class="params">person</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> name = person.<span class="property">name</span>;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;Hello, &#x27;</span> + name);</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> someone = &#123;<span class="attr">name</span>: <span class="string">&#x27;Dan&#x27;</span>&#125;;</span><br><span class="line"><span class="title function_">sayHi</span>(someone);</span><br><span class="line"></span><br><span class="line">someone = &#123;<span class="attr">name</span>: <span class="string">&#x27;Yuzhi&#x27;</span>&#125;;</span><br><span class="line"><span class="title function_">sayHi</span>(someone);</span><br><span class="line"></span><br><span class="line">someone = &#123;<span class="attr">name</span>: <span class="string">&#x27;Dominic&#x27;</span>&#125;;</span><br><span class="line"><span class="title function_">sayHi</span>(someone);</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>person.name</code> ä¸€é–‹å§‹æ˜¯ â€˜Danâ€™ï¼Œä½†æ˜¯æ¯æ¬¡ <code>sayHi</code> éƒ½æœƒç¶“æ­·ä»¥ä¸‹æ­¥é©Ÿ :</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ 1 æ¬¡ </span></span><br><span class="line"><span class="keyword">name</span> = Dan </span><br><span class="line">setTimout æ‹¿åˆ°çš„ <span class="keyword">name</span> æ˜¯å¤–éƒ¨çš„ <span class="keyword">name</span> = Dan</span><br><span class="line"><span class="comment">// ç¬¬ 2 æ¬¡</span></span><br><span class="line"><span class="keyword">name</span> = Yuzhi</span><br><span class="line">setTimout æ‹¿åˆ°çš„ <span class="keyword">name</span> æ˜¯å¤–éƒ¨çš„ <span class="keyword">name</span> = Yuzhi</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>ç”¨ JavaScript ä¾†èªªå°±æ˜¯é–‰åŒ… (closure) çš„æ¦‚å¿µï¼ŒCall Stack åˆ° <code>setTimeout()</code> çš„æ™‚å€™ï¼Œ<code>sayHi</code> è£¡é¢å®£å‘Šçš„è®Šæ•¸æœƒè¢«å„²å­˜ä¸‹ä¾†ï¼Œå­˜åœ¨å…§éƒ¨ï¼Œä¸¦æ²’æœ‰è¢«å›æ”¶æ‰ï¼Œå› æ­¤ <code>setTimeout()</code> ç•¶ä¸‹æ‹¿åˆ°çš„å€¼æ˜¯ <strong>å…§éƒ¨å·²ç¶“è¨ˆç®—å®Œä¸”è¢«è¨˜éŒ„èµ·ä¾†çš„å€¼</strong>ï¼Œæ‰æœƒæ˜¯æ•ç² (capture) ç•¶æ™‚çš„å€¼ã€‚</p><blockquote><p><code>setTimeout</code> æ‹¿åˆ°çš„å€¼æœƒæ˜¯ç•¶ä¸‹åŸ·è¡Œå®Œæ‰€è¨˜éŒ„ä¸‹çš„å€¼ï¼Œé€™ä¹Ÿèªªæ˜äº†ç‚ºä»€éº¼ useEffect æœƒæ‹¿åˆ°èˆŠçš„ state : <strong>ç•¶ä¸‹çš„ <code>setTimeout()</code> æ˜¯æ‹¿é–‰åŒ…çš„å€¼ã€‚</strong></p></blockquote><h3 id="å›é ­çœ‹-React-çš„-render-å…§éƒ¨çš„-function">å›é ­çœ‹ React çš„ render å…§éƒ¨çš„ function</h3><p>å·²ç¶“çŸ¥é“ <code>setTimeout</code> æœƒè¨˜éŒ„ä¸‹ç•¶æ¬¡ render çš„å€¼ï¼Œä¸ç®¡å“ªä¸€æ¬¡çš„ render ï¼Œå®ƒç•¶æ¬¡çš„ state èˆ‡ props éƒ½æœƒæ˜¯ä¸€æ¨£çš„ã€‚å¦‚æœæ˜¯ä¸åŒæ¬¡çš„ render ï¼Œå®ƒçš„ state å’Œ props æ˜¯ç¨ç«‹çš„ï¼Œåœ¨äº‹ä»¶ (event handler) æˆ–äº‹ä»¶å…§çš„éåŒæ­¥ (async/await) äº‹ä»¶ä¹Ÿéƒ½æ˜¯ä¸€æ¨£çš„åŸå‰‡ã€‚</p><p>ç¯„ä¾‹ç”¨ <code>inline function</code> æ˜¯å®‰å…¨çš„ (button çš„ click äº‹ä»¶)ï¼Œå› ç‚º state çš„ count ä¸æœƒæ¯æ¬¡éƒ½è¢«è®Šå‹• (æ„æ€æ‡‰è©²æ˜¯ <strong>ç”¢ç”Ÿæ–°çš„è¨˜æ†¶é«”ç©ºé–“</strong>ï¼ŒæŒ‡è·Ÿ object type çš„å·®åˆ¥)ï¼Œå¦‚æœ state æ˜¯ object type çš„é¡å‹ï¼Œå¿…é ˆç¢ºä¿ object æ˜¯ç”¨ <strong>Immutable</strong> çš„æ–¹å¼æ”¹è®Šã€‚</p><p>æ–‡ä¸­æåˆ° <code>setState(newObj)</code> æ˜¯åˆç†çš„ï¼Œç‚ºä»€éº¼é€™éº¼èªªå‘¢ ?<br> åªè¦<strong>è¨˜ä½æ¯æ¬¡ render éƒ½æœ‰è‡ªå·±çš„ state æˆ– props</strong> ï¼Œç›´æ¥æ”¹æ”¹æˆ <code>newObj</code>æ˜¯æ²’å•çš„ï¼Œå°æ–¼å‰ä¸€æ¬¡çš„ render ä¹Ÿæ˜¯å®Œæ•´çš„å€¼ã€‚<br> ğŸ‘‰ <a href="https://codepen.io/shan473/pen/jOzeWEb?editors=0011">codepen ç°¡æ˜“ç¯„ä¾‹ï¼Œè«‹çœ‹ useRef è®ŠåŒ–</a></p><p>ä¾‹å¦‚ : çµæ§‹é¡ä¼¼ï¼Œä½†æ˜¯å·¢ç‹€å…§éƒ¨æœ‰éƒ¨åˆ†æ”¹è®Š</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡å¦‚åŸæœ¬çš„ state</span></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  a : &#123;</span><br><span class="line">    b : <span class="number">2</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> newState = &#123;</span><br><span class="line">  a : &#123;</span><br><span class="line">    b : <span class="number">3</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// âœ… åˆ·æ–°æ•´ç­†è³‡æ–™ï¼Œé€™æ¨£æ²’å•é¡Œ</span></span><br><span class="line"><span class="title function_">setState</span>(newState)</span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ ç›´æ¥å°å€¼å…§éƒ¨äº›å¾®èª¿æ•´ï¼ŒReact æ ¹æœ¬å¯Ÿè¦ºä¸åˆ°ï¼Œä¸æœƒ re-render</span></span><br><span class="line"><span class="title function_">setState</span>(<span class="function"><span class="params">prevState</span> =&gt;</span> &#123;</span><br><span class="line">  prevState.<span class="property">a</span>.<span class="property">b</span> = newState.<span class="property">a</span>.<span class="property">b</span></span><br><span class="line">  <span class="keyword">return</span> prevState</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ç•¶æˆ‘å€‘è¦è§¸ç™¼ <code>setState</code> æ™‚ï¼ŒReact æœƒå…ˆç¶“é state çš„æ·ºæ¯”è¼ƒ (shallow comparison)ï¼Œå¦‚æœç›´æ¥æ”¹è®Šä¸¦ä¸æœƒ re-renderã€‚</p><h2 id="æ¯ä¸€æ¬¡-render-éƒ½å®ƒè‡ªå·±çš„-Effect">æ¯ä¸€æ¬¡ render éƒ½å®ƒè‡ªå·±çš„ Effect</h2><p>React æœƒè¨˜ä½æ¯å€‹ <code>useEffect</code>ï¼Œè§¸ç™¼çš„æ™‚é–“é»æ˜¯æ¯æ¬¡æ”¹è®Š DOM ä¹‹å¾Œèˆ‡ browser æ¸²æŸ“å®Œä¹‹å¾Œæ‰æœƒå‘¼å«ã€‚</p><p>æ¦‚å¿µä¸Šä¾†èªªï¼Œeffect æ˜¯é€™æ¬¡ render å¾Œçš„çµæœ (render å¾Œæ‰åŸ·è¡Œçš„)ï¼Œä½† effect å…¶å¯¦ä¹Ÿè·Ÿä¸Šé¢æåŠçš„ [[#å›é ­çœ‹ React çš„ render å…§éƒ¨çš„ function]] ç« ç¯€ä¸€æ¨£çš„æ¦‚å¿µï¼Œå…¶ state è·Ÿ props æ˜¯éƒ½æ˜¯å±¬æ–¼ç•¶æ¬¡ render çš„ï¼Œeffect ä¹Ÿæ˜¯ã€‚</p><h2 id="æ¯ä¸€æ¬¡-render-ä¿æœ‰å®ƒçš„æ‰€æœ‰æ±è¥¿">æ¯ä¸€æ¬¡ render ä¿æœ‰å®ƒçš„æ‰€æœ‰æ±è¥¿</h2><p>ç¯„ä¾‹<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> ã€‚<br> å·²ç¶“çŸ¥é“ function æ¯ä¸€æ¬¡çš„ render æœƒè¨ˆä¸‹ <code>useEffect</code>ï¼Œä¸¦ä¸”æ‹¿åˆ°å…§éƒ¨ <code>local state</code> çš„å€¼ã€‚</p><p>è·Ÿè‘— <code>setTimeout</code> è·‘ä¸€æ¬¡ :</p><ul><li>ç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span> æ¬¡ render<ol><li>state æ˜¯<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">0</span></span></span></span></li><li>React è¨˜ä¸‹ effect : 3 ç§’ä¹‹å¾Œ You clicked 0 times</li><li><code>Counter</code> å›å‚³æäº¤ UI çµ¦ React</li><li>React è·Ÿ DOM æºé€šä¸¦ä¸”ç€è¦½å™¨æ¸²æŸ“äº†ç•«é¢</li><li><code>useEffect</code> é€™æ™‚å€™å‘¼å« React æ‰€è¨˜ä¸‹çš„ effect ï¼Œç­‰åˆ° 3 ç§’ä¹‹å¾Œ : å°å‡º You clicked 0 times</li></ol></li></ul><p>æ¥è‘—æŒ‰ä¸‹ button è§¸ç™¼ <code>setCount</code> è®“ count + 1ï¼ŒReact é‡æ–°å‘¼å« <code>Counter()</code> ï¼Œé€²è¡Œç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span></span></span></span> æ¬¡æ¸²æŸ“</p><ul><li>ç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span></span></span></span> æ¬¡ render<ol><li>state è®Šæˆ<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span></li><li>React è¨˜ä¸‹ effect : 3 ç§’ä¹‹å¾Œ You clicked 1 times</li><li><code>Counter</code> å›å‚³æäº¤ UI çµ¦ React</li><li>React è·Ÿ DOM æºé€šä¸¦ä¸”ç€è¦½å™¨æ¸²æŸ“äº†ç•«é¢</li><li><code>useEffect</code> é€™æ™‚å€™å‘¼å« React æ‰€è¨˜ä¸‹çš„ effect ï¼Œç­‰åˆ° 3 ç§’ä¹‹å¾Œ : å°å‡º You clicked 1 times</li></ol></li></ul><p>å¾Œé¢ä»¥æ­¤é¡æ¨ã€‚<br> function component æ˜¯é€™æ¨£æ“ä½œï¼Œä½†æ˜¯ class Component åœ¨è™•ç† effect æ™‚å»ä¸æ˜¯é€™æ¨£çš„ã€‚</p><h3 id="è·Ÿ-class-Component-çš„å·®åˆ¥">è·Ÿ class Component çš„å·®åˆ¥</h3><p>ç¯„ä¾‹<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup><br> å‡¡æœ‰é—œ effect çš„æ“ä½œæœƒæ”¾åœ¨ <code>componentDidUpdate</code> é€™è£¡ï¼Œæ„æ€æ˜¯ <strong>state æˆ– props è®Šæ›´ä¹‹å¾Œè¦åšä»€éº¼äº‹</strong></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentDidUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`You clicked <span class="subst">$&#123;<span class="variable language_">this</span>.state.count&#125;</span> times`</span>);</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€™è£¡çš„ <code>this.state.count</code> éƒ½æœƒæ˜¯ç¾åœ¨çš„ countï¼Œä¹Ÿå°±æ˜¯æŒ‰åˆ° 5 <code>setTimeout</code> æŠ“åˆ°çš„éƒ½æœƒæ˜¯ 5 ï¼Œè€Œä¸æ˜¯ <strong>ç•¶ä¸‹</strong> è§¸ç™¼çš„ countã€‚</p><p>æ¯ä¸€æ¬¡ render éƒ½æ˜¯å‘¼å«å…§éƒ¨çš„ <code>render()</code> function ï¼Œ state æ°¸é æ˜¯æŒ‡åƒå¯¦ä¾‹çš„ stateã€‚</p><p>è¤‡ç¿’ä¸€ä¸‹ class component çš„ React ç”Ÿå‘½é€±æœŸæ˜¯</p><blockquote><ol><li><strong>Mouting</strong> : constructor ğŸ‘‰ render ğŸ‘‰ capture refs and DOM ğŸ‘‰DidMount</li><li><strong>Updating</strong> : render ğŸ‘‰ capture refs and DOM ğŸ‘‰DidUpdate</li></ol></blockquote><p>è·Ÿè‘— <code>setTimeout</code> è·‘ä¸€æ¬¡ :</p><ul><li>ç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span> æ¬¡ render <strong>(Mounting)</strong><ol><li><code>constructor</code> åˆå§‹åŒ– ï¼Œstate = 0</li><li><code>render</code> è§¸ç™¼ Counter å…§éƒ¨çš„ render ï¼Œä¸¦æäº¤ UI çµ¦ React</li><li><code>capture refs and DOM</code> React è·Ÿ DOM æºé€šä¸¦ä¸”ç€è¦½å™¨æ¸²æŸ“äº†ç•«é¢</li><li><code>DidMount</code> è¢«å‘¼å«ï¼Œå°å‡º : You clicked 0 times</li></ol></li></ul><p>æ¥è‘—æŒ‰ä¸‹ button è§¸ç™¼è®“ count + 1ï¼ŒReact é‡æ–°å‘¼å« Counter çš„ <code>render()</code> ï¼Œé€²è¡Œç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span></span></span></span> æ¬¡æ¸²æŸ“</p><ul><li>ç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span></span></span></span> æ¬¡ render <strong>(Updating)</strong><ol><li>æ­¤æ™‚ state çš„ count = 1ï¼Œ<code>setState</code> ç­‰åŒæ–¼åŸ·è¡Œåˆ° <code>Counter.state.count = 1</code> (æ³¨æ„ : ä½†é–‹ç™¼è€…ä¸èƒ½ç›´æ¥åœ¨å…ƒä»¶å…§éƒ¨é€™æ¨£åšï¼ŒReact å¹«æˆ‘å€‘åš )</li><li><code>render</code> è§¸ç™¼ Counter å…§éƒ¨çš„ render ï¼Œä¸¦æäº¤ UI çµ¦ React</li><li><code>capture refs and DOM</code> React è·Ÿ DOM æºé€šä¸¦ä¸”ç€è¦½å™¨æ¸²æŸ“äº†ç•«é¢</li><li>Counter å‘¼å« <code>componentDidUpdate</code>ï¼Œ3 ç§’ä¹‹å¾Œ Counter state æ˜¯ 1ï¼Œå°å‡º You clicked 1 times</li></ol></li></ul><p>å¥½ï¼Œé€™é‚Šçœ‹èµ·ä¾†æ²’å•é¡ŒğŸ¤”ã€‚</p><blockquote><p>é‚£éº¼ä¸é–“æ–·æŒ‰äº† 5 æ¬¡ï¼Œè€Œä¸”ä¸ç­‰æ¯æ¬¡ <code>setTimeout</code> çš„ç§’æ•¸è·‘å®Œå‘¢ ?</p></blockquote><p>ç­‰æ–¼ <code>Event Loop</code> ä¸­çš„ Call Stack é‚„åœ¨æ’éšŠçš„æƒ…æ³ï¼Œæœƒä¸€å€¼é‡è¤‡<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span> ~<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">3</span></span></span></span> é€™å€‹å‹•ä½œï¼Œä½†æ˜¯åˆ°äº†<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>4</mn></mrow><annotation encoding="application/x-tex">4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">4</span></span></span></span> !!!</p><blockquote><p>Counter å‘¼å« <code>componentDidUpdate</code>ï¼Œ3 ç§’ä¹‹å¾Œæ­¤æ™‚çš„ State æ˜¯ ???</p></blockquote><p>é€™æ™‚å€™ main thread ä¸Šçš„ Call Stack è·‘å®Œï¼ŒEvent Loop çš„ stack é–‹å§‹åŸ·è¡Œï¼Œæ­¤æ™‚çš„ <code>Counter.state.count = 5</code>ï¼ŒåŸ·è¡Œæ™‚å°å‡º <strong>You clicked 5 times</strong> ä¸¦ä¸”ä¾åºå°å‡º 5 æ¬¡</p><p>è¦è§£æ±ºæ­¤å•é¡Œå¾ˆç°¡å–®ï¼ŒæŠŠç•¶ä¸‹çš„ <code>this.state.count</code> å–ä¸‹ä¾†åŒ…çµ¦ <code>setTimeout</code> ï¼Œå…¶å¯¦ç­‰åŒæ–¼ <strong>closure</strong> çš„æ–¹å¼</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentDidUpdate</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> count = <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">count</span>;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`You clicked <span class="subst">$&#123;count&#125;</span> times`</span>);</span><br><span class="line">    &#125;, <span class="number">3000</span>);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>ç•¶éåŒæ­¥é€²å…¥ <code>Event Loop</code> è·‘å»æ’éšŠçš„æ™‚å€™ï¼Œé€™é‚Šçš„ <strong>count å·²ç¶“è¢«è¨˜èµ·ä¾†äº†</strong>ï¼Œæ‰€ä»¥ç•¶ <code>setTimout</code> åˆ° Call Stack çš„æ™‚å€™ï¼Œå°±æœƒæ˜¯ç•¶æ¬¡ render çš„ countã€‚</p><p>Closures å¾ˆå¥½ç”¨ï¼Œç•¶æˆ‘å€‘æŠŠå€¼é—œåœ¨å…§éƒ¨ï¼Œå³ä½¿å®ƒè„«é›¢äº† function ï¼Œä¸‹æ¬¡å†å‘¼å« function æ™‚å…¶å€¼é‚„æ˜¯æœƒè¢«ä¿ç•™ä½ä¸æœƒæ”¹è®Šã€‚å¯ä»¥æƒ³æˆæŠŠå®ƒæƒ³æˆé›·åŒ <code>const</code> å¸¸æ•¸ã€‚</p><h2 id="å¦‚ä½•æ‹¿å–æœ€æ–°çš„-state">å¦‚ä½•æ‹¿å–æœ€æ–°çš„ state ?</h2><p>æŠŠæ¡ä¸Šé¢æ‰€æåŠçš„åŸå‰‡ï¼Œ<strong>æ¯ä¸€æ¬¡ component åŸ·è¡Œ render functionï¼ŒåŒ…å« äº‹ä»¶ã€effect ç”šè‡³ timeouts æˆ–æ˜¯å…¶ä»– API éƒ½æœƒè¨˜ä½ç•¶æ¬¡å®šç¾©çš„ props æˆ– stateã€‚</strong></p><p>é€™å…©å€‹ç¯„ä¾‹å…¶å¯¦æ˜¯ä¸€æ¨£çš„ :</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Example</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="comment">//ğŸ“ ç­‰åˆ° render ä¹‹å¾Œæ‰è®€å– counter</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(props.<span class="property">counter</span>);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ğŸ“ ä¸€é–‹å§‹æŠŠ counter å­˜èµ·ä¾†</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Example</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> counter = props.<span class="property">counter</span>;</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(counter);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸ç®¡æ˜¯å…ˆé‚„æ˜¯å¾Œå»è®€å–å€¼ï¼Œæ‹¿åˆ°çš„ state æ˜¯ç›¸åŒçš„<br> <code>useEffect</code> å·²ç¶“è¨˜ä½ç•¶æ™‚çš„ state<br> state è·Ÿ props æ˜¯ä¸æœƒè®Šçš„</p></blockquote><p>å¦‚æœæˆ‘å€‘è©¦åœ–åœ¨ä¸Šä¸€æ¬¡çš„ render function å–å¾—æœ€æ–°çš„ props æˆ– stateï¼Œé€™æ¨£æ˜¯é€†æµè€Œä¸Š (æ–‡ç« é€™éº¼èªªçš„ğŸ¤”)ã€‚</p><p>æœ‰æ™‚å€™æˆ‘å€‘æœƒéœ€è¦åœ¨ effect ä¸­æ‹¿åˆ°æœ€æ–°çš„å€¼ï¼Œè€Œä¸æ˜¯ç•¶ä¸‹ render æ‰€è¨˜ä½çš„å€¼ï¼Œé€™ä¸¦ä¸æ˜¯ä»€éº¼éŒ¯èª¤çš„æ“ä½œï¼Œä½†æˆ‘å€‘å¯ä»¥ä½¿ç”¨ refs é”æˆç›®çš„ã€‚</p><p>refs ä¸æœƒä¿ƒä½¿ React re-renderï¼Œå› ç‚º React ç¢ºä¿å®ƒæ˜¯ä¸æœƒè¢«æ”¹è®Šçš„(æŒ‡ä¸æœƒå›  render ç”¢ç”Ÿæ–°çš„è¨˜æ†¶é«”ä½å€ï¼Œæ¯æ¬¡éƒ½æŒ‡å‘åŒä¸€å€‹å¯¦é«”)ã€‚ä¹Ÿå¯ä»¥æƒ³æˆ React å¹«æˆ‘å€‘å»ºç«‹ä¸€å€‹å…¨åŸŸçš„ç‰©ä»¶ï¼Œæˆ‘å€‘éƒ½æ˜¯å°åŒä¸€å€‹ç‰©ä»¶é€²è¡Œç›´æ¥æ“ä½œã€‚</p><blockquote><p>ç„¶è€Œé€†æµè€Œä¸Šæ˜¯ä»€éº¼æ„æ€å‘¢ ? ğŸ¤”</p></blockquote><p>functional component æ˜¯åˆ©ç”¨é–‰åŒ… (closure) çš„æ¦‚å¿µï¼Œå¾ JS çš„åŸºç¤æ¦‚å¿µä¾†çœ‹ï¼ŒåŸ·è¡Œå®Œ function å¾Œç”±æ–¼è£¡é¢çš„è®Šæ•¸é‚„æ˜¯å­˜åœ¨æ–¼ function å…§éƒ¨ (æ²’æœ‰è¢«å›æ”¶)ï¼Œä½†æ˜¯å­˜åœ¨å…§éƒ¨çš„è®Šæ•¸å¤–éƒ¨ä¸èƒ½ç›´æ¥æ“ä½œã€‚</p><p>å›åˆ° <code>setState</code> æœƒè§¸ç™¼ re-renderï¼Œé‡æ–°å‘¼å« component function ï¼Œä½†åœ¨ effect ä¸­ä»æ˜¯å±¬æ–¼ä¸Šä¸€æ¬¡ render çš„ï¼Œç•¶æˆ‘å€‘æƒ³åœ¨ effect å–å¾—æœ€æ–°çš„è³‡æ–™ä¾†æ“ä½œå°±åƒåœ¨å¤–éƒ¨å° closure å…§éƒ¨æ‹¿æŸè®Šæ•¸ï¼Œé€™æ˜¯ä¸è¡Œçš„ï¼Œå› ç‚ºå€¼è¢«å°è£åœ¨å…§éƒ¨ã€‚é™¤éæˆ‘å€‘åƒåœ¨å¤–éƒ¨å…ˆå»ºç«‹å¥½ä¸€å€‹å…¨åŸŸè®Šæ•¸ï¼Œä¸¦ä¸”ç›´æ¥æ‹¿å…¶å€¼é€²è¡Œæ“ä½œï¼Œæ²’éŒ¯ï¼Œé€™å°±ç­‰åŒæ–¼ refs çš„æ¦‚å¿µäº†ğŸ˜²</p><h2 id="ä½¿ç”¨-ref-ä¾†å–å¾—æœ€æ–°å€¼">ä½¿ç”¨ ref ä¾†å–å¾—æœ€æ–°å€¼</h2><p>å·²ç¶“çŸ¥é“ [[#è·Ÿ class Component çš„å·®åˆ¥|class component çš„è¡Œç‚º]] æœƒæ‹¿åˆ°æœ€æ–°çš„å€¼ï¼Œè€Œ function component å‰‡ä¸æœƒï¼Œè¦æ€éº¼ç”¨ function component å¾©åˆ» class çš„è¡Œç‚ºå‘¢ ?</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> latestCount = <span class="title function_">useRef</span>(count);</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ°æœ€æ–°çš„ count</span></span><br><span class="line">  latestCount.<span class="property">current</span> = count;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// è®€å–æœ€æ–°çš„ count</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`You clicked <span class="subst">$&#123;latestCount.current&#125;</span> times`</span>);</span><br><span class="line">  &#125;, <span class="number">3000</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ä¸€ä¾†ï¼Œé€£æŒ‰ 5 æ¬¡ï¼Œå°±æœƒå‘ˆç¾æœ€å¾Œé€šé€šå°å‡º<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">5</span></span></span></span> çš„çµæœã€‚<br> <strong>ref</strong> å°±åƒåœ¨å¤–éƒ¨å»ºç«‹ä¸€å€‹ç›’å­ï¼Œå¯„æ”¾ä¸æœƒè¢«æ”¹è®Šçš„å€¼</p><p>é€™æ¨£çš„æ–¹å¼ä¸èƒ½ä¿è­‰æ¯æ¬¡ function call çš„é‚£å€‹æœŸé–“ï¼Œstate æ˜¯æ­£ç¢ºçš„ (state ä¸å±¬æ–¼é‚£å€‹ç•¶ä¸‹çš„æ™‚é–“é»)ã€‚ç”±æ–¼æ¯æ¬¡éƒ½è¢«ç›´æ¥æ”¹è®Š (class component åšçš„äº‹)ï¼Œæ‹¿åˆ°çš„å°±æœƒæ˜¯æœ€æ–°çš„ã€‚<br> é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ React é è¨­ä¸æ˜¯ ref çš„æ“ä½œï¼Œè€Œæ˜¯é¸æ“‡æ€§çš„ã€‚</p><p>é€™è£¡å¯ä»¥æ¯”è¼ƒ functional component è·Ÿ class component å°æ–¼ render æ„ç¾©çš„ä¸åŒä¹‹è™• :</p><ul><li>class component å°‡æ¯æ¬¡ render åˆ†æˆä¸åŒéšæ®µä¾†æ±ºå®šç™¼ç”Ÿå“ªäº›äº‹ï¼Œä¹Ÿå°±æ˜¯ç”Ÿå‘½é€±æœŸã€‚åœ¨ A éšæ®µè®ŠåŒ–åˆ° B éšæ®µçš„éç¨‹ï¼Œè³‡æ–™ä¹Ÿæœƒéš¨æ™‚é–“ç™¼ç”Ÿè®ŠåŒ–ã€‚</li><li>functional component å‰‡æ˜¯æŠŠæ¯æ¬¡çš„ render æ˜¯ç¨ç«‹çš„ä¾†çœ‹ï¼Œé€™æ¬¡ render åªé—œæ³¨é€™æ¬¡è³‡æ–™çš„è®ŠåŒ–ï¼Œä¸¦ä¸”åŒæ­¥ä¸€åˆ‡çš„æ±è¥¿ã€‚</li></ul><h2 id="è«‡è«‡-clean-up">è«‡è«‡ clean up</h2><blockquote><p>clean up çš„æ˜¯èˆŠçš„ props é‚„æ˜¯ç•¶ä¸‹çš„ props ?</p></blockquote><p>å…ˆé‡æ¸… <code>clean up</code> çš„åŸ·è¡Œæ™‚é–“ï¼Œåœ¨ç•«é¢æ¸²æŸ“ä¹‹å¾Œï¼Œåœ¨ä¸‹ä¸€å€‹ effect åŸ·è¡Œä¹‹å‰ï¼ŒæœƒåŸ·è¡Œ clean up effectã€‚<br> <img data-src="https://raw.githubusercontent.com/donavon/hook-flow/master/hook-flow.png" alt="|400x500"></p><p>æ„æ€æ˜¯</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="comment">// 2ï¸âƒ£ åœ¨ return ä¹‹å¾Œæ‰æœƒåš</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> <span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 1ï¸âƒ£ é€™è£¡æœƒå…ˆåŸ·è¡Œ</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>æƒ…å¢ƒ : æœ‰ä¸€å€‹ state å¾ 10 æ”¹è®Šæˆ 20</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">ChatAPI</span>.<span class="title function_">subscribeToFriendStatus</span>(props.<span class="property">id</span>, handleStatusChange);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ChatAPI</span>.<span class="title function_">unsubscribeFromFriendStatus</span>(props.<span class="property">id</span>, handleStatusChange);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>ä¸€é–‹å§‹å¯èƒ½æœƒé€™éº¼æƒ³ :</p><ol><li>React å…ˆæ¸…é™¤ (clean up) å¸¶æœ‰ <code>id = 10</code> çš„è¨‚é–±</li><li>state æ›´æ–°è‡³ 20ï¼ŒReact æäº¤ UI çµ¦ç€è¦½å™¨æ¸²æŸ“</li><li>React effect åŸ·è¡Œå¸¶æœ‰ <code>id = 20</code> çš„è¨‚é–±</li></ol><p>ğŸ¤”é€™ä¸æ˜¯æ­£ç¢ºçš„ï¼ŒWhy ?</p><p>å›åˆ° Flow é‚£å¼µåœ–ï¼Œå¯ä»¥çŸ¥é“ effect åŸ·è¡Œçš„æ™‚é–“é»æ˜¯ <strong>ç€è¦½å™¨å°‡å…ƒç´ æ”¾ä¸Š DOM (browser painting)</strong> ä¹‹å¾Œï¼Œç‚ºä»€éº¼ React è¦é€™éº¼è¨­è¨ˆ ? ğŸ¤”</p><blockquote><p>æ‰ä¸æœƒé˜»æ””è¢å¹•çš„æ›´æ–°</p></blockquote><p>effect å¾ˆå¸¸è™•ç† AJAX å–è³‡æ–™çš„äº‹æƒ…ï¼Œ å¦‚æœå–è³‡æ–™é€™ä»¶äº‹ä¸æ˜¯å®‰æ’åˆ° effect ä¸­è™•ç†ï¼Œè€Œæ˜¯åŒæ­¥è™•ç†å‘¢ ? ç€è¦½å™¨å°±å¿…é ˆç­‰åˆ°è³‡æ–™å›å‚³å†å»åš painting çš„å·¥ä½œï¼Œå¦‚æœå›å‚³æ™‚é–“æ‹‰é•·ï¼Œè¢å¹•å°±æœƒåƒè¢«å¡ä½ã€å‹•å½ˆä¸å¾—ã€‚</p><p>React æ‰æœƒæŠŠ effect åŸ·è¡Œçš„æ™‚é–“é»æ”¾åœ¨ç€è¦½å™¨ painting ä¹‹å¾Œï¼Œä»¥ä¸é˜»æ“‹è¢å¹•æ›´æ–°ç‡çš„æƒ…æ³ä¸‹ï¼Œæå‡ UI é«”é©—ã€‚è€Œ <strong>Effect çš„ clean up function ä¹Ÿæœƒè¢«å»¶é²</strong>ã€‚</p><p>æ‰€ä»¥ä¸Šé¢çœŸæ­£çš„æƒ…å¢ƒé †åº</p><ol><li>state æ›´æ–°è‡³ 20ï¼ŒReact æäº¤ UI çµ¦ç€è¦½å™¨æ¸²æŸ“</li><li>ç€è¦½å™¨æ¸²æŸ“äº†ï¼Œä½¿ç”¨è€…çœ‹è¦‹ 20 å‡ºç¾åœ¨è¢å¹•ä¸Š</li><li>React æ¸…é™¤ effect ï¼Œ <code>id = 10</code></li><li>React åŸ·è¡Œ effect ï¼Œ<code>id = 20</code></li></ol><p>å¥‡æ€ªçš„æ˜¯ï¼Œç‚ºä»€éº¼å¯ä»¥åœ¨ <code>id = 20</code> çš„æƒ…æ³ä¸‹ï¼Œå»æ¸…é™¤ <code>id = 10</code> çš„å€¼å‘¢ ? ğŸ¤”</p><blockquote><p>æ¯ä¸€å€‹åœ¨ render å…§éƒ¨å‘¼å«çš„ function (åŒ…å« handlers ã€effect ç­‰ç€è¦½å™¨ APIs )ï¼Œéƒ½æœƒæ‹¿åˆ°ç•¶ä¸‹å®šç¾©çš„ state ã€‚</p></blockquote><p>å¯¦éš›ä¸Šæ¸…é™¤èˆ‡åŸ·è¡Œ effect çš„ state éƒ½æ˜¯ä¾†è‡ªç•¶æ¬¡ render çš„è³‡æ–™ï¼Œ<strong>effect åŸ·è¡Œçš„ä¸¦ä¸æœƒæ‹¿åˆ°æœ€æ–°çš„è³‡æ–™</strong> ï¼Œè€Œæ˜¯èˆŠ (ç•¶ä¸‹)çš„ã€‚</p><p>What !?ğŸ¤·</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ…å¯¦éš›ä¸Šæ˜¯é€™æ¨£çš„</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">ChatAPI</span>.<span class="title function_">subscribeToFriendStatus</span>(<span class="number">10</span>, handleStatusChange);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ChatAPI</span>.<span class="title function_">unsubscribeFromFriendStatus</span>(<span class="number">10</span>, handleStatusChange);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// âŒ ä¸æ˜¯é€™æ¨£çš„ï¼Œæˆ‘å€‘åœ¨æƒ³åƒçš„ clean up é›–ç„¶æ¸…é™¤çš„æ™‚é–“é» state å·²ç¶“æ”¹è®Šæˆ 20ï¼Œä½†ä»ç„¶æ˜¯å±¬æ–¼ id = 10 é‚£æ¬¡ render çš„</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="title class_">ChatAPI</span>.<span class="title function_">subscribeToFriendStatus</span>(<span class="number">20</span>, handleStatusChange);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title class_">ChatAPI</span>.<span class="title function_">unsubscribeFromFriendStatus</span>(<span class="number">10</span>, handleStatusChange);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>clean up æ˜¯å»¶å¾ŒåŸ·è¡Œï¼Œä¸¦ä¸ä»£è¡¨æ˜¯å±¬æ–¼ä¸‹æ¬¡çš„ renderã€‚ React æŠŠ effect ç›¸é—œæ“ä½œæ˜¯åœ¨ç€è¦½å™¨æ¸²æŸ“ä¹‹å¾Œçš„åŸå› ï¼Œç›®çš„è®“åŸ·è¡Œæ¯”é è¨­çš„é‚„è¦å¿«ã€‚</p><p>è€Œåœ¨ clean up function è¢«å‘¼å«æ™‚ï¼ŒèˆŠçš„ props æ°¸é éƒ½å­˜åœ¨ï¼Œä»¥é˜²æˆ‘å€‘éœ€è¦ç”¨åˆ°å®ƒã€‚</p><p>ä¾‹å¦‚ç›£è½äº‹ä»¶ï¼Œå¦‚æœæŸæŒ‰éµå…ƒç´ æ¶ˆå¤±æ–¼ç•«é¢ï¼Œæˆ‘å€‘æ‡‰è©²å°‡å®ƒçš„ç›£è½äº‹ä»¶è¨»éŠ·æ‰ï¼Œä½†æ˜¯åœ¨ render ä¹‹å¾Œå…ƒç´ æ—©å·²ç¶“å¾ç•«é¢æ¶ˆå¤±ï¼Œæˆ‘å€‘è¦æ€éº¼è¨»éŠ·ä¸€å€‹å·²ç¶“ä¸åœ¨ DOM ä¸Šçš„å…ƒç´ ç›£è½äº‹ä»¶å‘¢ ? clean up function è®“æˆ‘å€‘æŠŠèˆŠçš„ state æˆ– props é‚„å­˜åœ¨è‘—ï¼Œåœ¨ effect å‘¼å«ä¹‹å‰ï¼Œæˆ‘å€‘å°±å¯ä»¥æŠŠå®ƒè¨»éŠ·æ‰ã€‚</p><h2 id="åŒæ­¥åŸ·è¡Œä½†ä¸æ˜¯ç”Ÿå‘½é€±æœŸ">åŒæ­¥åŸ·è¡Œä½†ä¸æ˜¯ç”Ÿå‘½é€±æœŸ</h2><p>åœ¨ä½¿ç”¨ <code>useEffect</code> è¦è·³è„«ç”Ÿå‘½é€±æœŸçš„æ€è€ƒæ–¹å¼ï¼Œé‹ç”¨åŒæ­¥çš„æ¦‚å¿µã€‚</p><blockquote><p>ä¸€åˆ‡éƒ½æ˜¯è·Ÿçµæœæœ‰é—œï¼Œè€Œä¸æ˜¯éç¨‹</p></blockquote><p>é€™è·Ÿ JQuery å…ˆå‘¼å« <code>addClass</code> åˆå‘¼å« <code>removeClass</code> <strong>éç¨‹æ´¾åˆ¥</strong> æ˜¯ä¸åŒçš„ (æ„æ€æ˜¯ DOM æ–°å»ºç«‹æ±è¥¿ï¼Œåˆçµ¦å®ƒåˆªé™¤é€™æ¨£çš„è¡Œç‚º)ï¼Œé€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ React çš„ CSS class å¿…é ˆæ”¾åœ¨ render ç¨‹å¼ç¢¼ä¹‹ä¸­ (åªåœ¨ä¹çµæœï¼Œä¸¦ä¸æ˜¯å¾ A è®Š B çš„éç¨‹ç¶“æ­·äº†ä»€éº¼ã€‚åˆ¤æ–·æ¨£å¼éƒ½æ˜¯çœ‹æœ€çµ‚çš„çµæœï¼Œä¸¦ééš¨æ™‚é–“è€Œæ”¹è®Š)</p><p>React æ ¹æ“šç•¶ä¸‹çš„è³‡æ–™æ˜¯åŒæ­¥è™•ç† DOM (è³‡æ–™è·Ÿ UI æ˜¯åŒæ­¥çš„) ï¼Œåœ¨ function component ä¸­ render çš„ <code>mount</code> è·Ÿ <code>updating</code> æ˜¯æ²’æœ‰å€åˆ¥çš„ã€‚é€™æ¨£ä½¿ <code>useEffect</code> è®“æˆ‘å€‘å¯ä»¥æ ¹æ“š props æˆ– state åŒæ­¥ React æ¨¹ç‹€ä»¥å¤–çš„æ±è¥¿ã€‚</p><p>å‡å¦‚æœ‰ä¸€å€‹ state å¾ 10 è®Šåˆ° 20ï¼Œè·Ÿä¸€é–‹å§‹å°±è³¦äºˆå®ƒ 20 ï¼Œæœ€çµ‚éƒ½æœƒæ˜¯ 20ã€‚è·Ÿ call API æ‹¿è³‡æ–™ä¸€æ¨£ï¼Œæœ€å¾Œçš„çµæœéƒ½æœƒæ˜¯ä¸€æ¨£çš„ã€‚æˆ‘å€‘çœ‹åˆ°çš„ UI è·Ÿè³‡æ–™æ˜¯åŒæ­¥çš„ï¼Œä¹Ÿåªæœƒé¡¯ç¤ºæœ€å¾Œè³‡æ–™çš„çµæœã€‚</p><p>ä½†æ˜¯å¦‚æœæ¯æ¬¡éƒ½ re-render æ˜¯å¾ˆæ²’æ•ˆç‡çš„ï¼Œç”šè‡³å°è‡´ç„¡é™å¾ªç’°ã€‚</p><h2 id="å‘Šè¨´-React-ä¸åŒ-effect-ä¹‹é–“çš„å·®åˆ¥">å‘Šè¨´ React ä¸åŒ effect ä¹‹é–“çš„å·®åˆ¥</h2><p>é¿å…æ¯æ¬¡ä¸å¿…è¦çš„è³‡æ–™éƒ½è·Ÿè‘— re-renderï¼Œå¿…é ˆå‘Šè¨´ React é‚£äº›è¦ re-renderã€‚ (å¯ä»¥æƒ³æƒ³ render ä¹‹å¾Œçš„æ­¥é©Ÿé †åº)</p><ol><li>state æ”¹è®Šï¼Œrender æ–°çš„ UI</li><li>React render ï¼Œæäº¤ UI çµ¦ DOM</li><li>DOM æ›´æ–°ï¼Œç¶“éä¸€ç³»åˆ—æ“ä½œï¼Œæœ€å¾Œæ”¾ä¸Šç•«é¢ (é€™ä¹Ÿç‚ºä»€éº¼èªª æ“ä½œ DOM å¾ˆæ˜‚è²´ï¼Œå› ç‚ºç‰½æ¶‰åˆ°å¤ªå¤šç•«é¢çš„ reflowã€repaintï¼Œå°¤å…¶æ˜¯ reflow)</li></ol><p>React é¿å… DOM æ˜‚è²´çš„æ“ä½œï¼Œåªæœƒæ›´æ–° DOM ç¢ºå¯¦æœ‰æ”¹è®Šçš„åœ°æ–¹ã€‚</p><p>React Element æ˜¯ä¸€å€‹ Object è£è¼‰å„ç¨®å±¬æ€§ã€‚å‡å¦‚æœ‰ä¸€å€‹å…ƒä»¶æŒ‡æ”¹å‹•äº† <code>props.name</code> (ä¸åŒ…å« state çš„æ“ä½œ) ï¼Œä¹Ÿå°±æ˜¯æ–‡å­—çš„éƒ¨åˆ†åƒ…æœ‰ children æ”¹è®Šäº†ï¼ŒReact åªæœƒæ”¹å‹• <code>domNode.innerText</code> çš„éƒ¨ä»½è€Œå·² (åšæ·ºæ‹·è²æ¯”è¼ƒ shallow comparisonï¼Œé€™è·Ÿ React çš„ Recoil æœ‰é—œ)</p><p>ç¯„ä¾‹ä¾†è‡ª Dan å¤§çš„æ–‡ç«  :</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> oldProps = &#123;<span class="attr">className</span>: <span class="string">&#x27;Greeting&#x27;</span>, <span class="attr">children</span>: <span class="string">&#x27;Hello, Dan&#x27;</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> newProps = &#123;<span class="attr">className</span>: <span class="string">&#x27;Greeting&#x27;</span>, <span class="attr">children</span>: <span class="string">&#x27;Hello, Yuzhi&#x27;</span>&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>é‚£ React ä¹Ÿæœƒåœ¨ <code>useEffect</code> å¹«æˆ‘å€‘æª¢æŸ¥å— ?</p></blockquote><p><strong>ä¸æœƒã€‚</strong> React å°æ–¼æ²’æœ‰å‘¼å«çš„ functionï¼Œæ˜¯æ²’è¾¦æ³•å¹«æˆ‘å€‘æª¢æŸ¥ã€æ¯”è¼ƒã€‚</p><p>React ç‚ºäº†é¿å…ä¸€ç›´é‡è¤‡åŸ·è¡Œ effect æœ‰é—œçš„æ“ä½œï¼Œæä¾› <strong>dependency array</strong> (ä¹Ÿç¨± <strong>deps</strong> ) ï¼Œè®“æˆ‘å€‘åŠ å…¥è¦é—œæ³¨çš„è³‡æ–™çµ¦ <code>useEffect</code> åˆ¤æ–·ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">document</span>.<span class="property">title</span> = <span class="string">&#x27;Hello, &#x27;</span> + name;</span><br><span class="line">&#125;, [name]); <span class="comment">// ğŸ‘ˆ deps</span></span><br></pre></td></tr></table></figure><p>é€éé€™å€‹ array å‘Šè¨´ React ï¼Œé€™è£¡é¢</p><blockquote><p>åªæœ‰åŒ…å« array çš„è³‡æ–™æ”¹è®Šäº†æ‰è¦åŸ·è¡Œï¼Œå…¶é¤˜çš„è³‡æ–™è·Ÿæˆ‘ç„¡é—œï¼Œä¸è¦å«æˆ‘è¬è¬ã€‚</p></blockquote><p>React æ¯æ¬¡ re-render æœƒæª¢æŸ¥ array ä¸­çš„è³‡æ–™ï¼Œå¦‚æœå‰å¾Œéƒ½é•·çš„ä¸€æ¨£ï¼Œå°±æœƒè·³é <code>useEffect</code> ã€‚</p><p>åªè¦æ”¾å…¥ array ä¸­çš„è³‡æ–™ï¼Œå³ä½¿åªæœ‰ 1 å€‹æ”¹è®Šï¼Œä¹Ÿæœƒé‡æ–°åŸ·è¡Œ effect ï¼ŒReact å°±æœƒçŸ¥é“é€™æ˜¯ä¸èƒ½è·³éçš„ï¼Œå› ç‚º React æœƒåŒæ­¥æ‰€æœ‰äº‹æƒ…ã€‚</p><p>æ‰€ä»¥ä¸è¦æŠŠæ¯«ç„¡ç›¸é—œçš„æ”¾åœ¨ä¸€èµ·ï¼Œ<strong>é—œæ³¨æœƒæ”¹è®Šè€Œé‡æ–°å‘¼å«çš„è³‡æ–™ã€‚</strong></p><h2 id="ä¸è¦å°-dependencies-èªªè¬Š">ä¸è¦å° dependencies èªªè¬Š</h2><p>function Component ä¸­æ²’æœ‰ç”Ÿå‘½é€±æœŸï¼Œå¦‚æœæˆ‘å€‘åªæƒ³è¦åœ¨ <code>mount</code> åŸ·è¡Œä¸€æ¬¡å°±å¥½ï¼Œé€šå¸¸æœƒæŠŠ dependencies array å¯«æˆç©ºçš„ã€‚</p><p>ä¾‹å¦‚ : è¼‰å…¥è³‡æ–™</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">SearchResults</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// è¼‰å…¥è³‡æ–™</span></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ajax æ˜¯ side effect æŠŠå®ƒæ“ºåœ¨ useEffect åŸ·è¡Œ</span></span><br><span class="line">    <span class="title function_">fetchData</span>();</span><br><span class="line">  &#125;, []); <span class="comment">// ğŸ‘ˆ æ”¾å…¥ç©ºé™£åˆ— </span></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹èµ·ä¾†åˆç†å— ? å¦‚æœæœ‰ç‰½æ¶‰åˆ°å…¶ä»–çš„ props æˆ– state é€™è£¡å°±æœƒæœ‰å•é¡Œã€‚</p><h3 id="dependencies-èªªè¬Šäº†æœƒç™¼ç”Ÿä»€éº¼å•é¡Œ">dependencies èªªè¬Šäº†æœƒç™¼ç”Ÿä»€éº¼å•é¡Œ ?</h3><p>å¦‚æœä»¥è¨ˆæ™‚åŠŸèƒ½ (<code>setInterval</code>) åœ¨ class component ä¸­çš„å¯«æ³•æ€ç¶­ï¼Œåœ¨ function Component å°±è¦æ”¹è®Šé€™å€‹æƒ³æ³•ã€‚ <code>setInterval</code> é›–ç„¶åœ¨åŸºç¤çš„ JS å»ºç«‹ä¸€æ¬¡ï¼Œç€è¦½å™¨æœƒæŒçºŒè¨˜ä½ç›´åˆ°åˆªé™¤ id ç‚ºæ­¢ï¼Œä½†åœ¨ function Component æ¯ä¸€æ¬¡éƒ½æ“æœ‰è‡ªå·±çš„ scope ï¼Œæ‰€ä»¥å¿…é ˆé‡å°æ¯æ¬¡å‘¼å« render æ™‚ï¼Œå¦‚æœè¦æ”¹è®Šçš„è³‡æ–™å…·æœ‰å‰¯ä½œç”¨è¦å…ˆåˆªé™¤ï¼Œå†é‡æ–°ç”¢ç”Ÿï¼Œä¸ç„¶å°±æœƒä¸€ç›´å¾€ä¸Šç–ŠåŠ ï¼Œé€ æˆå•é¡Œã€‚</p><p>åœ¨ class Component ä¸­ï¼Œæœ‰é—œå‰¯ä½œç”¨çš„å•é¡Œæœƒåœ¨ <code>Mount</code> ç›£è½èˆ‡ <code>Unmout</code> è¨»éŠ·ç›£è½ï¼Œå¦‚æœåœ¨ä½¿ç”¨ <code>useEffect</code> ä¹Ÿæ˜¯åŒä¸€å€‹æ€ç¶­æ¨¡å¼å»æ€è€ƒï¼Œ æŠŠ dependencies array ç•¶ä½œæ˜¯ mount çš„è¡Œç‚ºï¼Œå°‡ array è¨­ç‚ºç©ºçš„ï¼Œä½†å…§éƒ¨å¦‚æœä½¿ç”¨åˆ°æœ‰é—œ props æˆ– state ï¼Œeffect åªæœƒåœ¨ render åŸ·è¡Œä¸€æ¬¡å¾Œå°±ä¸æœƒå†ç›´è¡Œäº†ã€‚</p><h3 id="èª å¯¦ä»¥å°-dependenciesï¼ŒæŠŠæœ‰é—œçš„æ”¾å…¥-array-ä¸­">èª å¯¦ä»¥å° dependenciesï¼ŒæŠŠæœ‰é—œçš„æ”¾å…¥ array ä¸­</h3><p>ç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span> ç¨®æ–¹å¼å°±æ˜¯æŠŠæ‰€æœ‰ç›¸é—œè³‡æ–™æ”¾å…¥ <code>useEffect</code> çš„ array ä¸­ï¼Œè®“ effect æŒ‰ç…§è³‡æ–™æ”¹è®Šå°±åŒæ­¥æ”¹è®Šã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(count + <span class="number">1</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;, [count]); <span class="comment">//ğŸ‘ˆ ç”¨åˆ°äº† count æ”¾å…¥ array</span></span><br></pre></td></tr></table></figure><p>ç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span></span></span></span> ç¨®æ˜¯æ”¹è®Š effect è£¡é¢çš„çµæ§‹ï¼Œä¸éœ€è¦æ¯è¼ª render éƒ½è¦æ¯”è¼ƒ array ä¸­çš„è³‡æ–™ï¼Œæ¸›å°‘ä¾è³´æ€§ï¼Œå¾€ä¸‹æœƒèªªæ˜æ€éº¼æ¸›å°‘ä¾è³´æ€§ã€‚</p><h2 id="æœ‰æ•ˆç‡çš„ä½¿ç”¨-useEffect">æœ‰æ•ˆç‡çš„ä½¿ç”¨ useEffect</h2><blockquote><p>å¦‚æœæˆ‘å€‘ä¸æƒ³æŠŠ state æ”¾å…¥ dependencies array å‘¢ ?</p></blockquote><blockquote><p>é€™ä¸æ˜¯å›ä¸å›é€†æˆ–æ˜¯åˆ»æ„æ“ä½œ<br> è€Œæ˜¯ <strong>React ä¸€å®šéœ€è¦é€éä¾è³´é™£åˆ—å»æ¯”è¼ƒé€™ç­†è³‡æ–™å— ?</strong> effect æ‰€åŸ·è¡Œçš„æ˜¯å…·æœ‰å‰¯ä½œç”¨çš„æ“ä½œã€‚è€Œ React éƒ½èƒ½çŸ¥é“ç•¶æ¬¡ render çš„æ‰€æœ‰è³‡æ–™ï¼Œæœ‰å¿…è¦æ¯æ¬¡éƒ½å»ç‰¹åˆ¥å‘Šè¨´ React é€™ç­†æ˜¯å¦å…·æœ‰è®ŠåŒ–å‘¢ ?</p></blockquote><p>å¯ä»¥å…ˆæå•è‡ªå·± <strong>é€™ç­†è³‡æ–™çš„æ˜¯ç‚ºäº†ä»€éº¼ ?</strong><br> ä¾‹å¦‚ Counter ä¸­æ¯ç§’åš <code>setCount(count + 1)</code>ï¼Œä½†<strong>å…¶å¯¦æˆ‘å€‘æ ¹æœ¬ä¸éœ€è¦æ¯”è¼ƒæ¯æ¬¡ render çš„ count æ˜¯å¤šå°‘</strong>ï¼Œä¹‹å¾Œå† <code>+1</code> ã€‚</p><p>Why ? ğŸ¤”</p><p>å› ç‚º React å¯ä»¥å¹«æˆ‘å€‘æ‹¿å‡ºå‰ä¸€æ¬¡çš„ stateï¼Œè€Œ <code>setInterval</code> æ¯æ¬¡æ˜¯ä»°è³´ <strong>å‰ä¸€æ¬¡çš„ state å† <code>+1</code></strong> ï¼Œé‚£éº¼å¯ä»¥ä½¿ç”¨ <code>setState</code> çš„ç¬¬äºŒç¨®æ–¹å¼ï¼Œ<code>setState</code> è£¡é¢ä½¿ç”¨ callback function æ‹¿åˆ°æœ€æ–°çš„ state ä¸¦å›å‚³æ–° stateã€‚</p><blockquote><p><code>setState((previousState)=&gt; return state)</code></p></blockquote><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// åƒæ•¸ c æœƒæ‹¿åˆ°å‰ä¸€æ¬¡çš„ countï¼Œå›å‚³ count+1 çš„çµæœ</span></span><br><span class="line">    <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;, []); <span class="comment">//ğŸ‘ˆ é€™è£¡å°±ä¸ç”¨æ”¾ä¾è³´é™£åˆ—</span></span><br></pre></td></tr></table></figure><p>å³ä½¿ä¸å‘Šè¨´ React æ­£ç¢ºçš„ dependencies arrayï¼Œ<code>setInterval</code> åœ¨ç¬¬ä¸€æ¬¡ render å¾Œéƒ½æœƒå­˜åœ¨ (ä¹Ÿå°±æ˜¯æœƒä¸æ–·çš„åŸ·è¡Œ)ï¼Œå› ç‚º <code>setInterval</code> æ˜¯å±¬æ–¼ <code>window</code> ä¹Ÿå°±æ˜¯ browser çš„ methodã€‚</p><p>åªæœ‰åœ¨ Component æœ¬èº« <code>unmout</code> æœƒåœä¸‹ä¾†ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ <code>return</code> çš„éƒ¨ä»½ã€‚</p><p>è©¦è‘—è·‘ä¸€æ¬¡ :</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// effect ç¬¬ä¸€æ¬¡æœƒè¢«åŸ·è¡Œï¼Œå®ƒæœƒåœ¨ç¬¬ä¸€æ¬¡ render å¾Œéƒ½å­˜åœ¨</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="number">0</span> =&gt; <span class="number">0</span> + <span class="number">1</span>); <span class="comment">// æ‰€ä»¥é€™é‚Šæ˜¯ setCount(1)</span></span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;,[])</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒæ¬¡ render </span></span><br><span class="line"><span class="keyword">const</span> count = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// useEffect ä¸åŸ·è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// setInterval() é€™å€‹é‚„æ˜¯æœƒåŸ·è¡Œï¼Œå› ç‚ºå®ƒå­˜åœ¨æ–¼ browser  è€Œä¸æ˜¯æ¯æ¬¡ render function</span></span><br></pre></td></tr></table></figure><p>æ–‡ä¸­ç¨±æ˜¯ <strong>å¦å®šå¼ä¾è³´é—œä¿‚</strong> (false dependencies)ï¼Œå› ç‚º React <strong>çŸ¥é“æ¯æ¬¡ render çš„ state å€¼</strong>ï¼Œè€Œç¯„ä¾‹ä¸­ <code>setCount</code> åšçš„äº‹åªæœ‰å›å‚³ <code>count + 1</code>ï¼ŒReact ä¸¦ä¸ç”¨ç‰¹åˆ¥å»æª¢æŸ¥å‰å¾Œå…©æ¬¡çš„ count state æ˜¯å¦ä¸€æ¨£ï¼Œå†å»åŸ·è¡Œã€‚</p><p>å¯ä»¥çœ‹åšå‘Šè¨´ React :</p><blockquote><p>ç¸½ä¹‹å¹«æˆ‘æŠŠ <code>c=&gt;c+1</code> çš„çµæœå›å‚³çµ¦æˆ‘ ï¼Œä¸è«– c æ˜¯ä»€éº¼ï¼ŒReact æ˜¯çŸ¥é“çš„ã€‚</p></blockquote><p>å°±åƒæŒ‡ç¤ºï¼Œé€™ç¨® <code>function setState</code> çš„æ–¹å¼å¦‚åŒæ‰¹æ¬¡ (batch) æ›´æ–°ä¸€æ¨£ã€‚</p><p>æˆ‘å€‘ç¢ºå¯¦ç§»é™¤ count æ¸›å°‘ä¾è³´æ€§ï¼Œä½†ä¸¦ä¸æ˜¯å° deps èªªè¬Šï¼Œåªæ˜¯æˆ‘å€‘çš„ effect æ²’æœ‰è®€å–ä¾†è‡ª render çš„ç¯„åœè£¡é¢çš„ countã€‚</p><h3 id="è©¦è‘—æ‹†è§£ä¸¦äº†è§£">è©¦è‘—æ‹†è§£ä¸¦äº†è§£</h3><p>æˆ‘ç”¨è‡ªå·±çš„è©±è§£é‡‹é€™æ®µï¼Œä¸€é–‹å§‹çœ‹çš„æ™‚å€™çœŸçš„å¾ˆåƒåŠ›ğŸ˜µ</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…ˆå›å‘³ä¸€ä¸‹åŸå§‹é•·ç›¸ï¼Œæˆ‘è¦é–‹å§‹å¹«å®ƒè®Šèº«å›‰ğŸ˜²</span></span><br><span class="line"><span class="keyword">const</span> [count,setCount] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="number">0</span> =&gt; <span class="number">0</span> + <span class="number">1</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;,[])</span><br></pre></td></tr></table></figure><p>ä¸Šé¢èªªåˆ° <code>setInterval</code> å…¶å¯¦å¯ä»¥çœ‹åšæŠŠ function æåˆ°å¤–éƒ¨ï¼Œå› ç‚º <code>useEffect</code> åª render ä¸€æ¬¡ï¼Œä»£è¡¨å…§éƒ¨çš„ function æ˜¯ä¸æœƒè®Šéš¨ render é‡æ–°å‘¼å« (æ”¹è®Š) çš„ï¼Œç­‰åŒæ–¼æŠŠ function æåˆ°å¤–é¢å­˜åœ¨ä¾†ã€‚</p><p>ç”±æ–¼ <code>setCount</code> æœ¬èº«å°±æ˜¯é€é <code>updater function</code> å›å‚³æ–°çš„ state å°±æˆ‘å€‘æŒ‰ç…§ä»–çš„æ¶æ§‹å›å‚³ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setIterval çš„ callback function çœ‹ä½œæŠŠæ±è¥¿å¯«åœ¨ render function ä»¥å¤–</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">countSomething</span> = (<span class="params">setCount</span>) =&gt; &#123;</span><br><span class="line">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + <span class="number">1</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>æŠŠæå‡ºçš„ function å¡å›å»ï¼Œä¸¦ä¸æœƒå½±éŸ¿åŸæœ¬çš„æ“ä½œ</li></ul><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ”¾å›å»</span></span><br><span class="line"><span class="keyword">const</span> [count,setCount] = <span class="title function_">useState</span>(<span class="number">0</span>)</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// å¡å›å»ä¸€æ¨£å¯ä»¥åŸ·è¡Œ</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">countSomething</span>(setCount);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;,[]) <span class="comment">// ğŸ‘ˆ ä¾è³´é™£åˆ—æ˜¯ç©ºçš„</span></span><br></pre></td></tr></table></figure><p>ä¾†æŒ‰ç…§æ­¥é©Ÿä¾†äººé«” render çœ‹çœ‹ï¼ŒæŒ‰ç…§ React æ¯æ¬¡ render éƒ½åŒæ­¥è³‡æ–™ä¾†çœ‹</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€æ¬¡ render</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. count = 0 </span></span><br><span class="line"><span class="keyword">const</span> count  = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// 3. é€²è¡Œ effect</span></span><br><span class="line">    <span class="keyword">const</span> id = <span class="title function_">countSomething</span>(setCount);  </span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. é€™é‚Šå…ˆ clean ï¼Œä½†ç¬¬ä¸€æ¬¡çš„ id æ˜¯ null</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;,[])</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¬¬äºŒæ¬¡ render</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* é›–ç„¶ useEffect ä¸æœƒåŸ·è¡Œ </span></span><br><span class="line"><span class="comment">  ä½†å…§éƒ¨çš„ setInterval æœƒç¹¼çºŒåŸ·è¡Œï¼Œç›´åˆ°è¢«æ¸…é™¤</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// ä¸æ˜¯é€™æ¨£ function ä¸€ç›´è¢«å‘¼å«ï¼Œè€Œæ˜¯å…§éƒ¨çš„ setInterval é–“éš”è§¸ç™¼å®ƒçš„ callback function</span></span><br><span class="line"><span class="title function_">countSomething</span>(setCount);</span><br></pre></td></tr></table></figure><p><code>setInterval</code> ä¸ç®¡åœ¨å“ªè£¡å‘¼å«ï¼Œç”±æ–¼å®ƒæ˜¯å±¬æ–¼ window (ç€è¦½å™¨) åº•ä¸‹çš„ apiï¼Œå¦‚æœæ²’æœ‰æ¸…é™¤ï¼Œé‚£éº¼ <code>window</code> ä¸€æ¨£æœƒæ¯é–“éš” x ç§’å‘¼å«ã€‚é€™å€‹ä¾‹å­è­‰æ˜ä¸è«–æ”¾åœ¨ render function å…§éƒ¨æˆ–æ˜¯å¤–éƒ¨ï¼Œ<code>setInterval</code> éƒ½æœƒé¢¨é›¨ç„¡é˜»çš„åŸ·è¡Œã€‚</p><blockquote><p>æ³¨æ„<br> æˆ‘å€‘è®€å–çš„ count å€¼å·²ç¶“ä¸æ˜¯ä¾†è‡ªæ–¼ render ç¯„åœçš„</p></blockquote><p>é€™æ˜¯ä»€éº¼æ„æ€å‘¢ ? ğŸ¤”</p><p>ç¶“ç”±ä¸Šé¢çš„è®ŠåŒ–å²ï¼Œå·²ç¶“çŸ¥é“è„«é›¢äº† render function ä¾ç„¶å¯ä»¥åŸ·è¡Œï¼Œé‚£é€™è£¡çš„ <code>setCount (c=&gt;c+1)</code> è£¡é¢çš„ <strong><code>c=&gt; c+ 1</code></strong> åˆæ˜¯å¦ä¸€å€‹ callback functionï¼Œé‚£ <code>c</code> é€™å€‹åƒæ•¸ä¾†è‡ªèª°é‡è¦å— ? æˆ‘å€‘æœ‰å¿…è¦å¡«å…¥é€™å€‹ c å€¼æ‰èƒ½è¨ˆç®—å— ? (æ„æ€æ˜¯ä¸€å®šè¦å¯«<code>setCount(anotherfunction(c))</code> æ‰èƒ½åŸ·è¡Œå— ? )</p><p>æˆ‘å†æŠŠ <code>setCount</code> è£¡é¢çš„ callback function åˆæ‹†å‡º render ä»¥å¤–ï¼Œå« <code>plusOne</code>ï¼Œä¸¦ä¸”æˆ‘æŠŠé€™å€‹ <code>plusOne</code> çœ‹åšæˆ‘å€‘è¦å° <code>setCount</code> åšæŸäº‹çš„è—åœ–ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title function_">countSomething</span> = (<span class="params">setCount</span>) =&gt; &#123;</span><br><span class="line">  <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(plusOne);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// å‘Šè¨´ React è³‡æ–™è¦åšçš„äº‹</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">plusOne</span>(<span class="params">c</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> c + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ğŸ‘‰ <a href="https://codesandbox.io/s/mystifying-williamson-s4799j?file=/src/index.js"><code>codsandbox</code> ç¯„ä¾‹</a></p><p>åœ¨æŠŠé€™ä¸²æ”¾å›å»ï¼Œä¸€æ¨£å¯ä»¥åŸ·è¡Œã€‚<code>setState</code> å¦‚æœæ˜¯ä½¿ç”¨ callback function çš„æ–¹å¼ä½¿ç”¨ï¼Œå…§éƒ¨å…¶å¯¦æ˜¯å‘¼å« <strong>updater function</strong><sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup>ï¼Œå®ƒæœƒä¿è­‰æ‹¿åˆ°æœ€æ–°çš„ stateï¼Œè€Œæˆ‘å€‘çš„ <code>plusOne</code> åªæ˜¯ updater function çš„å¦ä¸€ç¨®è¡¨é”æ–¹å¼ã€‚</p><p>å›åˆ° React render çš„æ¦‚å¿µ : <strong>æ¯æ¬¡ render éƒ½ä¿æœ‰è‡ªå·±çš„è³‡æ–™</strong>ï¼Œæ‰€ä»¥æˆ‘å€‘ä¸ç”¨ç‰¹åˆ¥æ”¾å…¥ deps ä¾†å‘Šè¨´ React ï¼Œå› ç‚º React å°±å·²ç¶“çŸ¥é“ç•¶æ¬¡çš„ stateã€‚</p><p>é€™æ®µæœ‰é»é¥’å£ï¼Œä½†å¹«åŠ©æˆ‘é‡æ¸…åˆ°åº•ç‚ºä»€éº¼ä¸ç”¨åŠ å…¥ deps å…§ä¾ç„¶å¯ä»¥åŸ·è¡Œé€™å€‹å•é¡Œã€‚</p><h2 id="å¾-Google-æ–‡ä»¶çš„æ›´æ–°äº†è§£-function-updater">å¾ Google æ–‡ä»¶çš„æ›´æ–°äº†è§£ function updater</h2><p>å¦‚ä¸Šé¢çš„ç¯„ä¾‹ï¼ŒçŸ¥é“å¯ä»¥ä½¿ç”¨ <code>setCount(c =&gt; c + 1)</code> é¿é–‹ deps å¡«å…¥ state ï¼Œä½† :</p><ol><li>ç‚ºä»€éº¼ä½¿ç”¨å‘¢ ?</li><li>è·ŸåŸæœ¬ <code>setCount( c + 1)</code> å·®åˆ¥åœ¨å“ª ?</li></ol><p>æ–‡ç« ä¸­èˆ‰ä¾‹ Google æ–‡ç« æ˜¯é›²ç«¯ç·¨è¼¯ã€‚ä¿®æ”¹çš„æ™‚å€™ï¼Œä¸¦ä¸æ˜¯æ¯æ¬¡éƒ½å‚³é€æ•´å€‹é é¢çš„å…§å®¹çµ¦ä¼ºæœå™¨ï¼Œæ–‡ç« å¦‚æœæª”æ¡ˆå¤§ï¼Œé‚£æ¨£å‚³é€è¦†è“‹å¤ªæ²’æ•ˆç‡äº†ã€‚é‚£æ€éº¼æºé€šçµ¦å¾Œç«¯è®“å®ƒè¨˜ä½æ–°å¢æˆ–ä¿®æ”¹çš„éƒ¨åˆ†å‘¢ ?</p><blockquote><p>é€éå‚³é <strong>å®šç¾©å¥½çš„è¡¨é”æ–¹å¼</strong></p></blockquote><p>å…¶å¯¦å¦‚æœä½¿ç”¨é redux å°±çŸ¥é“ dispatch èˆ‡ action çš„ç™¼è™Ÿæ–½ä»¤çš„æ¦‚å¿µï¼Œåªæœ‰å·²ç¶“å®šç¾©åˆ°çš„ action type å°æ‡‰ actions æ‰èƒ½å°è³‡æ–™å…§å®¹é€²è¡Œè®Šå‹•ã€‚é‚£ä¹Ÿå¯ä»¥æƒ³åƒ Google æ–‡ç« åœ¨ç·¨è¼¯æ™‚ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œ<em>ä½¿ç”¨è€…é»æ“ŠæŸå€‹æŒ‰éˆ•ï¼Œå¾Œç«¯å†åšå‹•ä½œ</em>ã€‚</p><p>å¦‚æ­¤ä¸€ä¾†é”åˆ° <strong>æ‰¾å‡ºæœ€å°åŒ–çš„è³‡æ–™ä¾†æ”¹è®Šé€™å€‹ component</strong> ï¼Œå¦‚åŒ Google æ–‡ä»¶ä¸æœƒé€æ•´é è³‡æ–™å‡ºå»æ”¹è®Šæ–‡ä»¶ã€‚</p><p>é€™ç¨®æ–¹å¼è·Ÿæ˜¯ React æ‰€å»ºè­°çš„åŸå‰‡ : <strong>å°‹æ‰¾æœ€å°åŒ–ä½†å®Œæ•´çš„ state</strong> çš„æ¦‚å¿µ (æ„æ€æ˜¯æœ‰äº›è³‡æ–™æ˜¯å¯ä»¥é€éè¨ˆç®—å‡ºä¾†çš„ï¼Œä¸ä¸€å®šæ‰€æœ‰è³‡æ–™éƒ½å¾—æ˜¯å…§éƒ¨çš„ stateï¼Œä¾‹å­è£œå……åœ¨å¾Œé¢)ï¼Œå·®åˆ¥æ˜¯é€™æ˜¯ update çš„ã€‚</p><p>æœ€å°åŒ–ä¸”å®Œæ•´çš„ state èˆ‰ä¾‹ :<br> ä»¥ todo list ç‚ºä¾‹ï¼Œæœ‰å­˜æ”¾æ‰€æœ‰ todo çš„é™£åˆ— state ï¼Œä½†æˆ‘æƒ³è¦å­˜å– todo çš„é•·åº¦ï¼Œä¸¦ä¸éœ€è¦å¦å¤–å„²å­˜çš„ state</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âŒ ä¸ç”¨é€™æ¨£</span></span><br><span class="line"><span class="keyword">const</span> [length,setLength] = <span class="title function_">useState</span>(<span class="literal">null</span>)</span><br></pre></td></tr></table></figure><p>å› ç‚ºå¯ä»¥å¾ <code>state.todos.length</code> å–å¾—ï¼Œé€™ç­†è³‡æ–™æ˜¯å¯ä»¥é€šéè¨ˆç®—å–å¾—ã€‚<br> é€™ä¹Ÿæ˜¯ç‚ºä»€éº¼ä¸Šé¢èªª <code>c =&gt; c + 1</code> æ˜¯ä¸€å€‹è—åœ–ï¼Œå› ç‚ºå®ƒå‚³é”çš„æ˜¯å€‹è³‡æ–™çš„è¡¨é”æ–¹å¼ã€‚</p><p>é‚£ç‚ºä»€éº¼ <code>setCount(c =&gt; c + 1)</code> æ¯”è¼ƒå¥½å‘¢ ? ğŸ¤”</p><p>åœ¨æ–¼ <strong>å®ƒæ²’æœ‰ç›´æ¥æ”¹è®Š count æœ¬èº«</strong> (æ²’æœ‰æ±™æŸ“åˆ°è®Šæ•¸)ï¼Œé€™å€‹ä¾‹å­ç”¨æœ€åŸå§‹çš„ JavaScript ä¾†çœ‹ã€‚ç”±æ–¼æœ¬æ¬¡çš„ count æ˜¯ primitive typeï¼Œé€™é‚Šä¸¦ä¸è¨è«– object type (React ä¹‹æ‰€ä»¥æœƒå»ºè­°è§£æ§‹ object type æ˜¯æœ‰åŸå› çš„)ã€‚</p><ul><li><code>c =&gt; c+1</code> : ä¸¦æ²’æœ‰æ”¹è®Šåˆ°åŸå§‹çš„ count</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> count = <span class="number">0</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">plusOne</span>(<span class="params">count</span>)&#123;</span><br><span class="line">  count =  count + <span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> count</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> newCount = <span class="title function_">plusOne</span>(count) <span class="comment">// ç”¨è®Šæ•¸æ¥èµ·ä¾†</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newCount) <span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(count) <span class="comment">// 0</span></span><br></pre></td></tr></table></figure><ul><li><code>c + 1</code> : ç›´æ¥å° count é€²è¡Œæ“ä½œğŸ˜µ</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> count = <span class="number">0</span> </span><br><span class="line"><span class="keyword">function</span> <span class="title function_">plusOne</span>(<span class="params"></span>)&#123;</span><br><span class="line">  count = count + <span class="number">1</span></span><br><span class="line">  <span class="keyword">return</span> count</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> newCount = <span class="title function_">plusOne</span>() </span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(count) <span class="comment">// 1</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(newCount) <span class="comment">// 1</span></span><br></pre></td></tr></table></figure><p>ä¸ç›´æ¥æ“ä½œè³‡æ–™ä¹Ÿæ˜¯é¿å…éé æœŸçš„çµæœç™¼ç”Ÿã€‚</p><p>é€™ç¨®æ–¹å¼ä¿è­‰æ›´æ–°å¤šå€‹ä¾†æº (äº‹ä»¶æˆ–æ˜¯å…·æœ‰å‰¯ä½œç”¨çš„æ“ä½œç­‰ç­‰) éƒ½å¯ä»¥è¢«åˆä½µæˆ <strong>å¯é æ¸¬çš„æ­£ç¢ºæ“ä½œ</strong>ã€‚ç„¶è€Œ <code>setCount(c =&gt; c + 1)</code> ä¸¦ä¸æ˜¯æœ€ä½³è§£æ³•ï¼Œé‡åˆ°ä»¥ä¸‹çš„æƒ…å¢ƒï¼Œå¯èƒ½æœƒç”¢ç”Ÿå¥‡æ€ªçš„å•é¡Œ :</p><ol><li>åŸ·è¡Œ effect åŒæ™‚ä¾è³´å¤šå€‹ state</li><li>é€é props è¨ˆç®—æ–°çš„ state</li></ol><p>é€™æ™‚å€™å¯ä»¥ä½¿ç”¨ <code>useReducer</code> ä¾†å¹«æˆ‘å€‘è§£æ±ºå•é¡Œã€‚</p><p><code>useReducer</code> å¯ä»¥çœ‹åšåŠ å¼·ç‰ˆçš„ useStateï¼Œè€Œäº‹å¯¦ä¸Š <code>useState</code> ä¹Ÿæ˜¯ <code>useReducer</code> ç°¡åŒ–éä¾†çš„ï¼Œæœ‰èˆˆè¶£å¯ä»¥åƒè€ƒé€™ç¯‡ <a href="https://medium.com/%E6%89%8B%E5%AF%AB%E7%AD%86%E8%A8%98/react-hooks-usestate-vs-usereducer-b14966ad37dd">React Hooks | æ—¢ç”Ÿ useState ä½•ç”Ÿ useReducer ? | by Airwaves | æ‰‹å¯«ç­†è¨˜ | Medium</a></p><h2 id="å°‡è³‡æ–™æ›´æ–°èˆ‡æ“ä½œåˆ†é›¢">å°‡è³‡æ–™æ›´æ–°èˆ‡æ“ä½œåˆ†é›¢</h2><p>ç¯„ä¾‹ä¸­ count æ˜¯è¢« step å½±éŸ¿ï¼Œæˆ‘å€‘ä¹Ÿç¢ºå¯¦å°‡æ­£ç¢ºçš„ deps æ”¾é€²å»ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> [step, setStep] = <span class="title function_">useState</span>(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setCount</span>(<span class="function"><span class="params">c</span> =&gt;</span> c + step);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">  &#125;, [step]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;step&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> setStep(Number(e.target.value))&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ç™½è©±æ–‡è§£é‡‹ : ç•¶ step æ”¹è®Šæ™‚ï¼Œ effect æœƒå…ˆæ¸…é™¤ä¸Šä¸€å€‹è¨ˆæ™‚å™¨ï¼Œæ¥è‘—ç”¢ç”Ÿæ–°çš„è¨ˆæ™‚å™¨ã€‚</p><blockquote><p>ä½†æ˜¯å¦‚æœä¸æƒ³è¦æ”¹è®Š step å°±é‡å•Ÿ interval é‡æ–°è¨ˆæ™‚å‘¢ ? å¦‚æœæƒ³è¦å‹•æ…‹çš„æ”¹è®Š step åˆèƒ½æŒçºŒè¨ˆæ™‚å‘¢ ?</p></blockquote><p>é‚£éº¼å°±å¿…é ˆæŠŠ step å¾ deps ç§»é™¤ï¼Œé¿å… step æ”¹è®Šä¹Ÿæ¸…é™¤ effect åˆç”¢ç”Ÿæ–°çš„ <code>setInterval</code> é‡è¨ˆã€‚</p><p>é€™ç¨®æƒ…æ³æ˜¯å¤šå€‹è³‡æ–™äº’ç›¸ä¾è³´ <code>(count â‡’ step)</code>ï¼Œè€Œä¸”æ˜¯ A è³‡æ–™è·Ÿ B è³‡æ–™ç¾åœ¨çš„å€¼æœ‰é—œã€‚(count æ¯ç§’å¢åŠ çš„å€¼ï¼Œè·Ÿ step çš„å€¼æœ‰é—œ)</p><p>å¯ä»¥æ”¹ä½¿ç”¨ <code>useReducer</code> ç®¡ç†è¤‡é›œçš„è³‡æ–™æµã€‚<code>useState</code> é€šå¸¸åªèƒ½å°è‘—ä¸€ç­†è³‡æ–™æ“ä½œï¼Œå¦‚æœæœ‰å¾ˆå¤šç­†ï¼Œå¯èƒ½æœƒå»ºç«‹å¤šå€‹ <code>useState</code>ã€‚æˆ–æ˜¯ç™¼è¦ºæ“ä½œè³‡æ–™æ˜¯ <strong>æ ¹æ“šæ–¼å‰ä¸€æ¬¡çš„è³‡æ–™</strong>ï¼Œé€™æ™‚å€™å¾ˆé©åˆæ›æˆ <code>useReducer</code>ã€‚</p><blockquote><p>reducer å¯ä»¥è®“æˆ‘å€‘é€é <strong>action type å°æ‡‰ action å†å»æ›´æ–°è³‡æ–™</strong> ï¼Œè€Œä¸”ä¹Ÿå¯ä»¥åŒæ™‚å°å¤šç­†è³‡æ–™æ“ä½œã€‚</p></blockquote><p>ä»€éº¼æ„æ€å‘¢ ? é‚£ <code>useState</code> ä¸èƒ½åšé€™æ¨£çš„äº‹å— ?<br> å¯ä»¥ï¼Œä½†æ˜¯éå¸¸éº»ç…©ï¼Œæœƒä½¿é‚è¼¯è®Šå¾—è¤‡é›œğŸ¤”ã€‚</p><p>æˆ‘è©¦è‘—å¾©åˆ»é€™å…©ç¨®æ–¹å¼çš„æ“ä½œ :</p><ol><li>ç…§èˆŠåˆ†é–‹çš„å…©å€‹è³‡æ–™ï¼ŒåŒæ™‚æ›´æ–°</li><li>ç”±æ–¼å…©å€‹æ˜¯ç›¸ä¾æ€§çš„ï¼ŒæŠŠå®ƒæ”¾åœ¨åŒä¸€å€‹è³‡æ–™ç‰©ä»¶ä¸­ã€‚</li></ol><p>å¦å¤–å¤šå‡ºä¾†çš„æ˜¯å˜—è©¦å…¶ä»–ç¨®æ–¹å¼ã€‚</p><ol><li>åŸå§‹ç¯„ä¾‹ : <a href="https://codesandbox.io/s/zxn70rnkx">Dan å¤§æä¾›çš„ CodeSandbox</a></li><li>å¯¦ä½œç¯„ä¾‹ : <a href="https://codesandbox.io/s/zealous-monad-rco7nx?file=/src/index.js">æˆ‘è¤‡è£½æ”¹éçš„ CodeSandbox</a>ï¼Œç¯„ä¾‹æœƒçœ‹åˆ°å¤šå€‹ä¸åŒçš„å¯«æ³•ï¼Œä»¥ä¸‹æœƒä¸€å€‹å€‹èªªæ˜ã€‚</li></ol><h3 id="å¯¦é©—-åˆ†é–‹çš„å…©ç­†è³‡æ–™æ›´æ–°">å¯¦é©— : åˆ†é–‹çš„å…©ç­†è³‡æ–™æ›´æ–°</h3><p>é¦–å…ˆè¦é‡æ¸…æ”¹è®Šå…¶å€¼çš„è®Šå› ï¼Œcount æ˜¯ä¾è³´è‘— stepï¼Œä½†æ˜¯ step æ˜¯æ‰‹å‹•è¼¸å…¥å€¼æ‰€æ”¹è®Šçš„ï¼Œå› æ­¤ step é›–ç„¶æ”¹è®Šäº†ï¼Œä½†æ˜¯ count ä¸èƒ½æ‹¿åˆ°æœ€æ–°çš„ stepã€‚</p><ul><li>é€éä¸Šé¢èªªéçš„ updater functionï¼Œæˆ‘å€‘å¯ä»¥çŸ¥é“ <code>(c =&gt; c)</code> é€™æ¨£å¯ä»¥æ‹¿åˆ°æœ€æ–°å€¼ã€‚</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [count, setCount] = <span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">const</span> [step, setStep] = <span class="title function_">useState</span>(<span class="number">1</span>);</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setStep</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// æœ€æ–°çš„ step</span></span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(s);</span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="title function_">setCount</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="comment">// é‚£é€™è£¡çš„ step å‘¢ ? ğŸ¤”</span></span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;step in count&quot;</span>, step);</span><br><span class="line">        <span class="keyword">return</span> c + step;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure><p>å…¶ä»–éƒ¨åˆ†è·ŸåŸç¯„ä¾‹ä¸€æ¨£æ²’æœ‰æ›´æ”¹ã€‚</p><blockquote><p>ç•¶ç„¶çµæœæ˜¯ä¸è¡Œçš„ã€‚</p></blockquote><p>è©¦è‘—ç”¨ <code>setStep</code> æ‹¿åˆ°æœ€æ–°çš„ stepï¼Œä¸¦ä¸ä»£è¡¨ç•¶ä¸‹å–å¾—çš„ step æœƒæ˜¯æœ€æ–°çš„ã€‚React æ–°æ‰‹æœ€å¸¸é™·å…¥çš„é™·é˜±æ˜¯åŸ·è¡Œ <code>setState</code> å¾Œé¦¬ä¸Šè®€å– state å€¼ï¼Œstate ä¸æœƒæ˜¯æ–°çš„ã€‚<br> é€™è·Ÿ <code>setState</code> æ˜¯éåŒæ­¥çš„æœ‰é—œä¿‚ã€‚</p><p>å›åˆ°é‚£å¥è©± : <strong>æ¯ä¸€æ¬¡ render éƒ½æ“æœ‰å®ƒå°ˆå±¬çš„ state æˆ– props</strong> ã€‚<br> æ‰€ä»¥ <code>setCount</code> è£é ­çš„ step é‚„åœç•™åœ¨ç¬¬ä¸€æ¬¡ render ï¼Œ<code>step = 1</code>ã€‚å³ä½¿ä¿®æ”¹ input çš„å€¼ï¼Œé›–ç„¶ <code>setStep</code> é‚£è¡Œå¯ä»¥æ‹¿åˆ°æœ€æ–°çš„ stepï¼Œä½†æ²’è¾¦æ³•åœ¨ <code>setCount</code> è£¡é¢æ‹¿åˆ°ã€‚</p><h3 id="å¯¦é©—-å†æŸç­†è³‡æ–™å…§éƒ¨æ‹¿åˆ°æœ€æ–°">å¯¦é©— : å†æŸç­†è³‡æ–™å…§éƒ¨æ‹¿åˆ°æœ€æ–°</h3><p>é‚£åœ¨ <code>setStep</code> ä¸­æ‹¿åˆ°æœ€æ–° step åœ¨å‚³çµ¦ <code>setCount</code> ç¸½å¯ä»¥äº†å§ğŸ¤”</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line"><span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setStep</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setCount</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;step in count&quot;</span>, step);</span><br><span class="line">        <span class="keyword">return</span> c + s;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;, []);</span><br></pre></td></tr></table></figure><p>è®Šå¾—è¶Šä¾†è¶Šè¤‡é›œäº†ï¼ŒèªçœŸæ‹†è§£çš„è©±å°±æ˜¯ callback hell äº†ã€‚åŒä¸Šé¢èªªçš„å¦‚æœ deps æ˜¯ç©ºçš„ï¼Œstate å†ä¹Ÿä¸æ˜¯å–è‡ª render function è£¡é¢ï¼ŒåŒæ¨£å¯ä»¥æŠŠé€™äº› method çœ‹ä½œå¯«åœ¨å¤–éƒ¨ã€‚</p><ul><li>ä¸Šé¢å°±åƒ :</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‹†è§£å†æ‹†è§£</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">countSomething</span> = (<span class="params">setCount</span>) =&gt; <span class="function">(<span class="params">setStep</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// callback å† callback</span></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setStep</span>(<span class="function">(<span class="params">s</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setCount</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> c + s);</span><br><span class="line">      <span class="keyword">return</span> s;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨</span></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line"> <span class="keyword">const</span> id = <span class="title function_">countSomething</span>(setCount)(setStep);</span><br><span class="line"> <span class="keyword">return</span> <span class="function">()=&gt;</span> <span class="title function_">cleanInterval</span>(id)</span><br><span class="line">&#125;,[])</span><br></pre></td></tr></table></figure><p>çœ‹èµ·ä¾†é‚„è¡ŒğŸ¤”ï¼Œä½†æˆ‘èªç‚ºé€™æ¨£çš„æ¶æ§‹ä¸å¥½è¢«æ“´å±•ï¼Œé™¤éè£¡é¢åˆå†æ‹†ï¼Œä¸éåŒæ™‚ä¹Ÿè®“æˆ‘æƒ³åˆ° HOC (Higher Order Component)ï¼Œé€™æ¨£çš„æ–¹æ³•æœƒæœ‰æ•ˆèƒ½ä¸Šçš„å•é¡Œã€‚</p><h3 id="å¯¦é©—-object-type-çš„-state">å¯¦é©— : object type çš„ state</h3><p>æˆ‘èªç‚ºé€™å€‹ä¾‹å­æ˜¯æœ€æ¥è¿‘ <code>useReducer</code> çš„ï¼ŒåŒæ™‚å¿…é ˆæŠŠçµæ§‹å¤§æ”¹ï¼Œä¸¦ä¸”ç”¨ immutable çš„æ–¹å¼æ”¹è®Šè³‡æ–™ã€‚</p><ul><li><code>useState</code> è¨­ç‚º object :</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 1. æŠŠæ‰€æœ‰ç›¸é—œçš„ state æ”¾å…¥åŒä¸€å€‹å®¹å™¨ä¸­</span></span><br><span class="line">  <span class="keyword">const</span> [value, setValue] = <span class="title function_">useState</span>(&#123;</span><br><span class="line">     <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">     <span class="attr">step</span>: <span class="number">1</span></span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 2. ä¸€æ¨£ä½¿ç”¨ updater function æ‹¿åˆ°æœ€æ–°å€¼</span></span><br><span class="line">    <span class="title function_">setValue</span>(<span class="function">(<span class="params">v</span>) =&gt;</span> (&#123; ...v, <span class="attr">count</span>: v.<span class="property">count</span> + v.<span class="property">step</span> &#125;));</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">  &#125;, []);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      &#123;/* 3. step ä¹Ÿè¦ä¿®æ”¹ */&#125;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&#123;value.step&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setValue(&#123; ...value, step: Number(e.target.value) &#125;)&#125;</span></span><br><span class="line"><span class="language-xml">      /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥½åƒæ¯”ä¸Šé¢éƒ½æ›´ä¾†çš„ç²¾ç°¡ï¼Œåªæ˜¯æ”¹è®Š state è®Šæˆå¾ˆå›‰å”†ğŸ˜µ</p><h3 id="å¯¦é©—-æŠŠ-input-è®Šæˆ-uncontrolled-component">å¯¦é©— : æŠŠ input è®Šæˆ uncontrolled component</h3><p>åœ¨ [[#ä½¿ç”¨ ref ä¾†å–å¾—æœ€æ–°å€¼]] é€™ç« ç¯€å·²ç¶“æœ‰æåˆ°ï¼Œæ­é…ä¸Šè¡¨å–®çš„æ§åˆ¶ï¼Œå¯ä»¥è®“æˆ‘å€‘ä¸ re-render çš„æƒ…æ³ä¸‹ï¼Œä¾ç„¶æ‹¿åˆ° input çš„æœ€æ–°å€¼ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stepRef = <span class="title function_">useRef</span>(<span class="number">1</span>);</span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">setCount</span>(<span class="function">(<span class="params">c</span>) =&gt;</span> c + <span class="title class_">Number</span>(stepRef.<span class="property">current</span>.<span class="property">value</span>));</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¹æˆ</span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">ref</span>=<span class="string">&#123;stepRef&#125;</span> <span class="attr">defaultValue</span>=<span class="string">&#123;1&#125;</span> /&gt;</span></span></span><br></pre></td></tr></table></figure><h2 id="å›åˆ°-useReducer">å›åˆ° useReducer</h2><ul><li>æŒ‰ç…§æ–‡ç« ä¸­æä¾›çš„ <code>useReducer</code> ç¯„ä¾‹</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹å€¼</span></span><br><span class="line"><span class="keyword">const</span> initialState = &#123;</span><br><span class="line">  <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">  <span class="attr">step</span>: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">reducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="comment">// è§£æ§‹ state</span></span><br><span class="line">  <span class="keyword">const</span> &#123; count, step &#125; = state;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ“šä¸åŒçš„ action type ä¾†æ”¹è®Š stateï¼Œå¦‚æœ type ä¸€å¤šç”¨ switch case</span></span><br><span class="line">  <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">&#x27;tick&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">count</span>: count + step, step &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">&#x27;step&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; count, <span class="attr">step</span>: action.<span class="property">step</span> &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// useReducer </span></span><br><span class="line">  <span class="keyword">const</span> [state, dispatch] = <span class="title function_">useReducer</span>(reducer, initialState);</span><br><span class="line">  <span class="comment">// è§£æ§‹å€¼</span></span><br><span class="line">  <span class="keyword">const</span> &#123; count, step &#125; = state;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// dispatch ä¸€å€‹ action</span></span><br><span class="line">      <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;tick&#x27;</span> &#125;);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">  &#125;, [dispatch]); <span class="comment">//ğŸ‘ˆ deps æ”¾å…¥ dispatch</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">&#123;step&#125;</span> <span class="attr">onChange</span>=<span class="string">&#123;e</span> =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-xml">        // ä¸€æ¨£ dispatch action</span></span><br><span class="line"><span class="language-xml">        dispatch(&#123;</span></span><br><span class="line"><span class="language-xml">          type: &#x27;step&#x27;,</span></span><br><span class="line"><span class="language-xml">          step: Number(e.target.value)</span></span><br><span class="line"><span class="language-xml">        &#125;);</span></span><br><span class="line"><span class="language-xml">      &#125;&#125; /&gt;</span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/&gt;</span></span></span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£é€™æœ‰æ¯”è¼ƒå¥½å— ? æ„æ€æ˜¯ deps æ”¾å…¥ dispatch ä¸æ˜¯æœƒå›åˆ° <code>setInterval</code> åˆé‡æ–°çš„ç‹€æ³å— ?</p><p>äº‹å¯¦ä¸Šå¯ä»¥é€™éº¼åšæ˜¯å› ç‚º <strong>React ä¿è­‰ dispatch æ°¸é è¢«ä¸æœƒæ”¹è®Š</strong>ï¼Œæ‰€ä»¥å®ƒä¸æœƒè®“ state æ”¹è®Šåˆé‡æ–°å•Ÿå‹•è¨ˆæ™‚ã€‚ç”±æ–¼ dispatch ä¸æœƒæ”¹è®Šï¼Œæ‰€ä»¥ <code>prevDispatch === nextDispatch</code>ã€‚</p><p><code>useEffect</code> çš„ deps å¯ä»¥å¿½ç•¥</p><ol><li><code>dispatch</code></li><li><code>setState</code></li><li><code>useRef</code> å®¹å™¨å€¼ : æŒ‡ <code>ref.current</code></li></ol><p>å› ç‚º React ä¿è­‰ä»–å€‘æ˜¯éœæ…‹çš„ï¼Œä¸æœƒè¢«æ”¹è®Šã€‚ä¸éæŒ‡å®šä»–å€‘ä¹Ÿä¸æœƒæ€éº¼æ¨£ã€‚</p><p>å›åˆ°å„ªé»çš„éƒ¨åˆ†ï¼Œæ¯”èµ·åœ¨ effect è£¡é¢ç›´æ¥è®€å– <code>state</code>ï¼Œ<strong>dispatch acition</strong> çµ¦äºˆä¸€å€‹è³‡æ–™è¡¨é”çš„æ–¹å¼ï¼Œä¸¦ä¸”åœ¨å¤–éƒ¨çš„ reducer æŒ‰ç…§ action type æ“ä½œè³‡æ–™ã€‚è®“ effect æŠŠ step é€™å€‹ state åˆ†é–‹ä¾†çœ‹å¾…ï¼Œcount è·Ÿ step çš„ä¾è³´æ€§å°±ä¸æœƒå› åœ¨ render function å°è‡´ä¸åŒæ­¥çš„å•é¡Œã€‚</p><p>effect ä¸é—œæ³¨æ€éº¼æ›´æ–° stateï¼Œè€Œæ˜¯ä»€éº¼å‹•ä½œè¦ç™¼ç”Ÿï¼Œä¸¦åœ¨ reducer é›†ä¸­è™•ç†é€™äº›è³‡æ–™é‚è¼¯ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">reducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; count, step &#125; = state;</span><br><span class="line">  <span class="comment">// æ”¶åˆ° tickï¼Œreducer å®šç¾© tick å°è³‡æ–™åšæŸä»¶äº‹ï¼Œå›å‚³ count : count + step</span></span><br><span class="line">  <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">&#x27;tick&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">count</span>: count + step, step &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">&#x27;step&#x27;</span>) &#123;</span><br><span class="line">    <span class="comment">// æ”¶åˆ° stepï¼Œå° step è³‡æ–™åšé‡æ–°è³¦å€¼</span></span><br><span class="line">    <span class="keyword">return</span> &#123; count, <span class="attr">step</span>: action.<span class="property">step</span> &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç‚ºä»€éº¼-useReducer-æ˜¯-Hooks-çš„ä½œå¼Šæ–¹å¼">ç‚ºä»€éº¼ useReducer æ˜¯ Hooks çš„ä½œå¼Šæ–¹å¼ ?</h2><p>æ–‡ä¸­æå‡ºä¸€å€‹æƒ…å¢ƒ</p><blockquote><p>å¦‚æœæ˜¯ step é€é props å‚³ä¸‹ä¾†çš„å€¼å‘¢ ?</p></blockquote><ul><li>æ–‡ä¸­ç¯„ä¾‹</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨çˆ¶å…ƒä»¶æŠŠ step å¾€ä¸‹å‚³ </span></span><br><span class="line">&lt;<span class="title class_">Counter</span> step=&#123;<span class="number">1</span>&#125; /&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params">&#123; step &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, dispatch] = <span class="title function_">useReducer</span>(reducer, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// å› ç‚º step  æ˜¯ props ï¼Œè¦æŠŠ reducer æ¬é€²ä¾†æ‰èƒ½è®€å–åˆ°</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">reducer</span>(<span class="params">state, action</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">&#x27;tick&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> state + step;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// é€™é‚Šéƒ½æ²’è®Š</span></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">dispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&#x27;tick&#x27;</span> &#125;);</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> <span class="built_in">clearInterval</span>(id);</span><br><span class="line">  &#125;, [dispatch]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€™å€‹ç¯„ä¾‹æœ‰å„ªåŒ–ä¸Šçš„å•é¡Œï¼Œä¸è¦ç•¶ä½œåˆç†çš„ä½¿ç”¨æ–¹å¼ã€‚(æˆ‘è¦ºå¾—æ˜¯ reducer function ä¸æ–·æ–°ç”¢ç”Ÿçš„å•é¡Œï¼Œé€šå¸¸æœƒç”¨ <code>useCallback</code> é¿å…æ¯æ¬¡ render é‡æ–°ç”¢ç”Ÿã€‚)</p><p>é€™å€‹ç¯„ä¾‹ dispatch ä¾ç„¶ä¸æœƒæ”¹è®Šï¼Œæ‰€ä»¥ effect è£é ­ä¸¦ä¸æœƒ re-renderã€‚å› ç‚º step ä¸å±¬æ–¼ <code>useReducer</code> çš„ stateï¼Œ<code>reducer</code> æ€éº¼çŸ¥é“ props ç”¢ç”Ÿè®ŠåŒ–è€Œæ‹¿åˆ°æœ€æ–°çš„ props å‘¢ ?</p><p>ç”±æ–¼ effect ä¸æœƒå†åŸ·è¡Œï¼ŒReact æœƒè¨˜ä½ dispatch ä¸­çš„ actionï¼Œä½†é€™ä¾ç„¶æœƒåœ¨ä¸‹æ¬¡ re-render (state æˆ–æ˜¯ props æ”¹è®Š) å‘¼å« reducer ã€‚é€™æ™‚å€™ props æ˜¯æ–°çš„ï¼Œreducer æ¥æ”¶åˆ°çš„ props ä¹Ÿæ˜¯æ–°ï¼Œä½†ä¸æ˜¯åœ¨ effect æ‹¿åˆ°ã€‚</p><p>é€™ä¹Ÿå°±æ˜¯ç‚ºä»€éº¼ Dan å¤§èªª <code>useReducer</code> åƒæ˜¯ Hooks çš„ä½œå¼Šæ¨¡å¼ï¼Œå› ç‚º<strong>æŠŠæè¿°äº‹æƒ…è·Ÿæ›´æ–°é‚è¼¯æ“ä½œåˆ†é–‹äº†</strong>ã€‚å¦å¤–ä¸€æ–¹é¢ï¼Œå¯ä»¥ç§»é™¤ä¸€äº› effect ä¸­ä¸éœ€è¦çš„ depsï¼Œé¿å…ä¸å¿…è¦çš„ re-renderã€‚</p><h3 id="ç™½è©±ç¿»è­¯æ©Ÿ">ç™½è©±ç¿»è­¯æ©Ÿ</h3><p>å…ˆç¢ºå®šå¹¾ä»¶äº‹ :</p><ol><li>effect æ˜¯ä¸æœƒé‡æ–°å‘¼å«ï¼Œå› ç‚º dispatch æ°¸é éƒ½æ˜¯åŒä¸€å€‹</li><li>dispatch ç™¼é€çš„åªæ˜¯ä¸€å€‹ <code>action</code>ï¼Œè€Œä¸”ä¹Ÿä¸æœƒæ”¹è®Šã€‚è€Œ reducer æ˜¯æ¥æ”¶ action type ä¾†å° state æ“ä½œã€‚</li><li>reducer åœ¨ render function ç¯„åœå…§ï¼ŒæŒ‰ç…§åŸæœ¬æ¯ä¸€å€‹ render éƒ½æœ‰å®ƒçš„ state æˆ– props ï¼Œä¹Ÿå°±æ˜¯ç•¶ Counter å›  state æˆ– props æ”¹è®Šè€Œ re-render ï¼Œreducer ä¹Ÿæœƒç”¢ç”Ÿæ–°çš„ function ï¼Œä¹Ÿæœƒæ‹¿åˆ°ç•¶å‰ render ç¯„åœçš„ propsã€‚</li><li><code>setInterval</code> ä¾ç„¶é–“éš”ç§’æ•¸åŸ·è¡Œã€‚</li></ol><p>å¦‚æœç”¨ redux çš„æƒ³æ³•ä¾†æ€è€ƒï¼Œæœƒçœ‹éé€™å¼µç¶“å…¸çš„åœ–ï¼Œæ¯”è¼ƒå®¹æ˜“ç†è§£ï¼Œdispatch æ¥æ”¶ä¸€å€‹ç‰©ä»¶ï¼Œä¸¦å†å‚³çµ¦ reducer è™•ç†æœ€å¾Œè¿”å› stateã€‚<br> <img data-src="https://redux.js.org/assets/images/ReduxDataFlowDiagram-49fa8c3968371d9ef6f2a1486bd40a26.gif" alt="|300x230"></p><p>å¡ä½çš„è©±ï¼Œå†è©¦è‘—ä¸€æ­¥æ­¥æ‹†è§£ã€‚<br> æŠŠ dispatch çœ‹ä½œæ”¾åœ¨å¤–éƒ¨çš„ function æ¥æ”¶ actionï¼Œä¸¦ä¸”å…§éƒ¨å‘¼å« reducer<br> ğŸ‘‰ <a href="https://codepen.io/shan473/pen/mdxKvYj?editors=0010">å˜—è©¦ç”¨ <code>codepen</code> ä¸¦ç”¨ Vanilla JS å¾©åˆ»</a></p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡çš„ dispatch ğŸ‘‰ ä¸åœ¨ render function è£¡é¢</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakedispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">  <span class="comment">// éƒ½å‘¼å«ä¾†è‡ª component ä¸­çš„ reducerï¼Œæ›´æ–°ç›®å‰çš„ state</span></span><br><span class="line">  component.<span class="title function_">fakereducer</span>(component.<span class="property">state</span>,action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Counter component : ç”±æ–¼ React Element æ˜¯ä¸€å€‹ Objectï¼Œæ‰€ä»¥æˆ‘è½‰æ›æˆç°¡åŒ–ä¸€äº› Object çµæ§‹ã€‚</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">const</span> step = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> prev = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">let</span> component = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// props æ¨¡ä»¿æ˜¯ç”±å¤–éƒ¨å‚³å…¥çš„ props</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params">props = <span class="literal">null</span></span>) &#123;</span><br><span class="line">  <span class="comment">// æ˜¯ä¸æ˜¯ç¬¬ä¸€æ¬¡ render</span></span><br><span class="line">  <span class="keyword">if</span>(component)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">state</span> = component.<span class="property">state</span>;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">props</span> = props || component.<span class="property">props</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> = count;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">props</span> = props || &#123;step : step&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æŠŠ React Element çœ‹æˆä¸€å€‹ Object</span></span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Object</span>.<span class="title function_">assign</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">    <span class="attr">state</span>: <span class="variable language_">this</span>.<span class="property">state</span>,</span><br><span class="line">    <span class="attr">props</span>: <span class="variable language_">this</span>.<span class="property">props</span>,</span><br><span class="line">    <span class="comment">// ğŸ˜² fakereducerï¼Œæ”¾åœ¨ render function å…§éƒ¨</span></span><br><span class="line">    <span class="attr">fakereducer</span>: <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">&quot;tick&quot;</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> += <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">step</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(action.<span class="property">type</span> === <span class="string">&quot;reset&quot;</span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>Interval : è·Ÿä¹‹å‰çš„åœ¨ <code>useReducer</code> é¡ä¼¼ï¼Œåªæ˜¯åœ¨ dispatch ä¹‹å¾Œæ‰‹å‹• re-renderï¼Œå› ç‚ºæˆ‘å€‘æ”¹è®Šäº† state</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡è£ç­‰æ–¼ useEffect(()=&gt;&#123;&#125;,[]) ,deps ç‚ºç©º</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">tick</span>(<span class="params"></span>) &#123;</span><br><span class="line">  id = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fakedispatch</span>(&#123; <span class="attr">type</span>: <span class="string">&quot;tick&quot;</span> &#125;);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¹è®Šä¸€ä¸‹ dispatch å…§éƒ¨</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakedispatch</span>(<span class="params">action</span>) &#123;</span><br><span class="line">  prev = component</span><br><span class="line">  <span class="comment">// è¦è·Ÿ prev æ¯”è¼ƒçš„</span></span><br><span class="line">  <span class="keyword">let</span> temp = <span class="keyword">new</span> <span class="title class_">Counter</span>(prev.<span class="property">props</span>);</span><br><span class="line">  <span class="comment">// æ›´æ–° state</span></span><br><span class="line">  temp.<span class="title function_">fakereducer</span>(component.<span class="property">state</span>,action)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//  å‡è£ setState çš„æ¦‚å¿µï¼Œç”±æ–¼ state ä¸åŒï¼Œè€Œre-render</span></span><br><span class="line">  <span class="keyword">if</span>(temp.<span class="property">state</span> !== prev.<span class="property">state</span>)&#123;</span><br><span class="line">    <span class="comment">// é‡æ–°å‘¼å« component æ›´æ–°</span></span><br><span class="line">    component = temp  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ›´æ–°ç•«é¢</span></span><br><span class="line">    title.<span class="property">textContent</span> = component.<span class="property">state</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä»£è¡¨ re-render</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;re-render&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è™•ç† <code>&lt;Counter step=&quot;1&quot;/&gt;</code> props æ”¹è®Šæ™‚ä¹Ÿ re-renderï¼Œç”±æ–¼æ˜¯ input çš„å€¼æ”¹è®Šå°è‡´ props æ”¹è®Š (re-render)ï¼Œæˆ‘å€‘å°±æ¨¡æ“¬é€™å€‹å‹•ä½œã€‚</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">input.<span class="title function_">addEventListener</span>(<span class="string">&quot;input&quot;</span>, <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> result;</span><br><span class="line">  <span class="comment">// æª¢æŸ¥è¼¸å…¥æ˜¯ä¸æ˜¯æ•¸å­—</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="title class_">Number</span>.<span class="built_in">isNaN</span>(<span class="title class_">Number</span>(e.<span class="property">target</span>.<span class="property">value</span>)))&#123;</span><br><span class="line">    result =<span class="number">1</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    result =<span class="title class_">Number</span>(e.<span class="property">target</span>.<span class="property">value</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// re-render ä¸¦å‚³å…¥ props</span></span><br><span class="line">  component = <span class="keyword">new</span> <span class="title class_">Counter</span>(&#123;<span class="attr">step</span>: result&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><ul><li>åŸ·è¡Œ</li></ul><h3 id="äººé«”ç·¨è­¯">äººé«”ç·¨è­¯</h3><p><code>useEffect</code> åœ¨ä¸Šé¢çš„ç« ç¯€èªªéï¼Œå¦‚æœ deps æ²’æœ‰ä»»ä½•æ±è¥¿ï¼Œeffect åªæœƒ render ä¸€æ¬¡ï¼Œå…¶ è³‡æ–™å·²ç¶“ä¸æ˜¯ä¾†è‡ªæ–¼ render function æœ¬èº«ï¼Œå¯ä»¥æŠŠå®ƒçœ‹ä½œæ‹¿åˆ° render å¤–éƒ¨ä¸€æ¨£ã€‚<br> æ‰€ä»¥æˆ‘å€‘è£½ä½œå‡çš„ <code>useEffect</code> æ˜¯å°æ‡‰ <code>tick()</code>ï¼Œ ä¸¦ä¸”åœ¨ component ç”Ÿæˆä¹‹å¾Œå‘¼å«ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">component = <span class="keyword">new</span> <span class="title class_">Counter</span>(&#123;step&#125;);</span><br><span class="line"><span class="title function_">tick</span>();</span><br></pre></td></tr></table></figure><ul><li>ç·¨è­¯ : é€™è£¡æœ‰å…©ç¨®æƒ…å¢ƒï¼Œ(1) æœ¬èº« state æ”¹è®Š ï¼›(2) å‚³å…¥çš„ props æ”¹è®Š</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ”¹è®Š Counter çš„ state</span></span><br><span class="line"><span class="keyword">const</span> count = <span class="number">0</span></span><br><span class="line"><span class="keyword">const</span> step = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¢ç”Ÿ fakereudcer </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakereducer</span>(<span class="params">action</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">&quot;tick&quot;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> += <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">step</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(action.<span class="property">type</span> === <span class="string">&quot;reset&quot;</span>)&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tick() setInterval æ¯ç§’å‘¼å« dispatch ä¸¦é€ action çµ¦ fakereducer</span></span><br><span class="line"><span class="title function_">fakedispatch</span>(&#123;<span class="attr">type</span>: <span class="string">&#x27;tick&#x27;</span>&#125;) <span class="comment">//ğŸ‘‰ count = 0 + 1 </span></span><br><span class="line"><span class="comment">// component state æ”¹è®Šï¼Œre-render ã€ç•«é¢æ›´æ–°</span></span><br><span class="line">temp = <span class="keyword">new</span> <span class="title class_">Counter</span>(<span class="number">1</span>);</span><br><span class="line">component = temp</span><br><span class="line">title.<span class="property">textContent</span> = component.<span class="property">state</span>; <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ”¹è®Š props çš„ step = 4ï¼Œprops æ”¹è®Š re-render</span></span><br><span class="line">component = <span class="keyword">new</span> <span class="title class_">Counter</span>(&#123;<span class="attr">step</span>: <span class="number">4</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¢ç”Ÿæ–°çš„ fakereducer</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fakereducer</span>(<span class="params">action</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (action.<span class="property">type</span> === <span class="string">&quot;tick&quot;</span>) &#123;</span><br><span class="line">      <span class="comment">// é€™æ¬¡ render 1 += 4 = 5</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> += <span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">step</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(action.<span class="property">type</span> === <span class="string">&quot;reset&quot;</span>)&#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">state</span> = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾Œé¢éƒ½æ˜¯å‘¨è€Œå¾©å§‹ã€‚é›–ç„¶ä¸æ˜¯å¾ˆæº–ç¢ºçš„æ¨¡ä»¿ React ï¼Œé€éæ‹†è§£çš„æ–¹å¼æˆ‘æ¯”è¼ƒå¥½ç†è§£ã€‚æˆ‘å€‘å¯ä»¥çŸ¥é“ reducer æ˜¯å› ç‚ºæ‹¿å– props çš„æœ€æ–°å€¼ï¼Œæˆ‘å€‘æ‰æŠŠå®ƒæ”¾åœ¨ component å…§éƒ¨ï¼Œä½†æ˜¯æœƒé€ æˆä¸ç®¡ props æ˜¯ä¸æ˜¯æœ‰æ”¹è®Šéƒ½æœƒç”¢ç”Ÿæ–°çš„ reducer ã€‚æˆ‘å¯èƒ½æœƒç”¨ <code>useCallback</code> è¨˜æ†¶èµ·ä¾†ï¼Œä¸¦åŠ ä¸Š <code>props.step</code> ä½œç‚º depsã€‚</p><p>è—‰ç”±é€™å€‹ä¾‹å­æˆ‘å€‘çŸ¥é“ dispatch åªè¦è² è²¬æŠŠ action å¸¶çµ¦ reducer å°±å¥½ï¼Œæˆ‘å€‘ä¸ç”¨åœ¨å…§éƒ¨å¯¦ä½œè©³ç´°é‚è¼¯ï¼Œè€Œæ˜¯äº¤çµ¦ reducer è™•ç†ï¼Œæ¸›å°‘åƒ <code>setState</code> ç›´æ¥åœ¨ effect ä¸­æŠŠè³‡æ–™æ‹†é–‹åˆå¡å›å»ï¼Œè€Œä¸”å¦‚æœæ˜¯å¤šçµ„è³‡æ–™é›†ä¸­æ–¼ä¸€å€‹ stateï¼Œç‰½ä¸€é«®å‹•å…¨èº«ğŸ˜µã€‚</p><h2 id="æŠŠ-function-ç§»åˆ°-useEffect-ä¸­">æŠŠ function ç§»åˆ° useEffect ä¸­</h2><p><code>useEffect</code> å¾ˆå¸¸æ‹¿ä¾†åš call API æ‹¿è³‡æ–™ï¼Œä¹Ÿå¾ˆå¸¸åªåšè¼‰å…¥é é¢çš„é‚£ä¸€æ¬¡ã€‚æŒ‰ç…§ effect åªåŸ·è¡Œä¸€æ¬¡ï¼Œæˆ‘å€‘çš„ deps æœƒæ˜¯ç©ºçš„ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">SearchResults</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useState</span>(&#123; <span class="attr">hits</span>: [] &#125;);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">axios</span>(</span><br><span class="line">      <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=react&#x27;</span>,</span><br><span class="line">    );</span><br><span class="line">    <span class="title function_">setData</span>(result.<span class="property">data</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchData</span>();</span><br><span class="line">  &#125;, []);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çœ‹èµ·ä¾†æ˜¯å¯è¡Œçš„ï¼Œæ¯”è¼ƒä¸å¥½çš„é»åœ¨æ–¼ <code>fetchData</code> æ²’æœ‰ä¾é ä»»ä½• state æˆ– propsï¼Œæ¯ä¸€æ¬¡ render éƒ½æ˜¯é•·ä¸€æ¨£çš„ï¼Œä½†åˆæœƒæ¯æ¬¡ç”¢ç”Ÿæ–°çš„ functionğŸ¤”ã€‚</p><blockquote><p>å¦‚æœåªç”¨åˆ°å‡½æ•¸å…§éƒ¨çš„å€¼ï¼Œæ²’æœ‰ä¾é å¤–éƒ¨è³‡æ–™ï¼ŒæŠŠå®ƒæ”¾åˆ° effect function ä¸­</p></blockquote><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// æŠŠ function æ¬åˆ° effect å…§éƒ¨</span></span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getFetchUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=react&#x27;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">axios</span>(<span class="title function_">getFetchUrl</span>());</span><br><span class="line">    <span class="title function_">setData</span>(result.<span class="property">data</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">fetchData</span>();</span><br><span class="line">&#125;, []); <span class="comment">// âœ… deps æ˜¯ç©ºçš„ä¹Ÿæ²’é—œä¿‚ï¼Œå› ç‚ºæ²’æœ‰ç”¨åˆ° state æˆ– props</span></span><br></pre></td></tr></table></figure><p>æˆ‘å€‘ä¸ç”¨å†æ“”å¿ƒ deps çš„å•é¡Œï¼Œå› ç‚ºç¢ºç¢ºå¯¦å¯¦ä¹Ÿæ²’æœ‰ä¾è³´ä»»ä½•å¤–éƒ¨è³‡æ–™ã€‚</p><p>ä½†æ˜¯ç•¶çµæ§‹é–‹å§‹è®Šçš„é¾å¤§ï¼Œè€Œä¸”æ¶‰åŠ state èˆ‡ propsï¼Œé€™æ™‚å€™å¦‚æœç•¶è³‡æ–™æ”¹è®Šäº†ï¼Œä½† effect ä¸¦ä¸æœƒæ›´æ–°ï¼Œä¾ç„¶åªæœƒåœç•™åœ¨ç¬¬ä¸€æ¬¡ render ä¸¦ä¸”ä¸æœƒå†åŸ·è¡Œäº†ğŸ˜µã€‚</p><blockquote><p>é‚£æŠŠ state æˆ– props åŠ å…¥ deps å‘¢ ?</p></blockquote><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [query, setQuery] = <span class="title function_">useState</span>(<span class="string">&#x27;react&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">getFetchUrl</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=&#x27;</span> + query;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">fetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="title function_">axios</span>(<span class="title function_">getFetchUrl</span>());</span><br><span class="line">    <span class="title function_">setData</span>(result.<span class="property">data</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">fetchData</span>();</span><br><span class="line">&#125;, [query]); <span class="comment">// âœ… é€™æ¨£æ˜¯åˆç†</span></span><br></pre></td></tr></table></figure><p>å¦‚æ­¤ä¸€ä¾†ç•¶ <code>query</code> æ”¹è®Šï¼Œeffect å°±æœƒé‡æ–°å‘¼å«ï¼Œæˆ‘å€‘æ‹¿åˆ°çš„è³‡æ–™ä¹Ÿéƒ½æœƒåŒæ­¥ã€‚</p><p>åŠ å…¥ deps ä¸åªæ˜¯è®“ React ä¸è¦ç™¼å‡ºè­¦å‘Šã€‚è€Œæ˜¯å»ç†è§£ç›¸é—œè³‡æ–™çš„è®ŠåŒ–ï¼Œä¾‹å¦‚ : æ‹¿å–è³‡æ–™æ˜¯ä¾é  <code>query</code> å­—ä¸²çš„è®ŠåŒ–ï¼ŒæŠŠ query æ”¾å…¥ deps å¯ä»¥è®“æˆ‘å€‘æ‹¿åˆ°ç•¶æ¬¡æ­£ç¢ºçš„è³‡æ–™ã€‚</p><p><code>useEffect</code> å¼·è¿«è®“æˆ‘å€‘æ³¨æ„è³‡æ–™æµæ‡‰è©²è¦æ€éº¼è®ŠåŒ–ï¼Œä¹Ÿå‘Šè¨´æˆ‘å€‘ä¹Ÿè¦è®“ effect ä¸€èµ·åŒæ­¥æ›´æ–°ï¼Œè€Œä¸æ˜¯å¿½ç•¥å®ƒï¼Œè®“ä½¿ç”¨è€…è™•è™•ç¢°åˆ° bugğŸ˜µ</p><h2 id="ä¸èƒ½æŠŠ-function-ç§»å…¥-useEffect-æ€éº¼è¾¦">ä¸èƒ½æŠŠ function ç§»å…¥ useEffect æ€éº¼è¾¦ ?</h2><p>å¦‚æœæœ‰ä¸€å€‹ function åœ¨ä¸åŒçš„ effect ä¸­é€²è¡Œï¼Œé‚£ function åœ¨æ¯æ¬¡ re-render éƒ½æœƒè¢«é‡æ–°å‰µé€ ï¼Œå¦‚æœåŠ å…¥ deps æœƒå°è‡´é »ç¹çš„æ›´æ–°ã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ğŸ”´ re-render éƒ½æœƒä½¿ effect é‡æ–°ç”¢ç”Ÿä¸¦å‘¼å«ï¼Œæ³ä¸”é‚„ä¾é™„å…©å€‹ğŸ˜µ</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getFetchUrl</span>(<span class="params">query</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=&#x27;</span> + query;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="title function_">getFetchUrl</span>(<span class="string">&#x27;react&#x27;</span>);</span><br><span class="line">&#125;, [getFetchUrl]); <span class="comment">// ğŸš§ deps æ˜¯æ­£ç¢ºçš„ä½†æ˜¯æ”¹è®Šçš„å¤ªé »ç¹</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="title function_">getFetchUrl</span>(<span class="string">&#x27;redux&#x27;</span>);</span><br><span class="line">&#125;, [getFetchUrl]); <span class="comment">// ğŸš§ deps æ˜¯æ­£ç¢ºçš„ä½†æ˜¯æ”¹è®Šçš„å¤ªé »ç¹</span></span><br></pre></td></tr></table></figure><p>çµ•å°ä¸æœƒæƒ³æŠŠå®ƒè¤‡è£½è²¼åˆ° effect è£¡é¢ğŸ˜µã€‚æ‰€ä»¥è§£æ±ºçš„æ–¹å¼æœ‰å…©ç¨® :</p><ul><li>ç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span></span></span></span> ç¨® : å¦‚ä¸Šé¢ä¸€ç›´æåŠçš„ä¸€ç¨®æ–¹å¼ï¼ŒæŠŠå®ƒæåˆ° render function å¤–éƒ¨ã€‚å¦‚æœå¿˜è¨˜äº†å¯ä»¥å›æƒ³ä¸€ä¸‹ [[#æœ‰æ•ˆç‡çš„ä½¿ç”¨ useEffect]] ç« ç¯€ï¼Œæ¦‚å¿µä¸Šè³‡æ–™ä¾†æºæ˜¯ä¸å±¬æ–¼ render function ç¯„åœçš„ã€‚</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… æåˆ°å¤–éƒ¨ï¼Œä¸æœƒå†è¢« render å…§éƒ¨çš„è³‡æ–™å½±éŸ¿äº†</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getFetchUrl</span>(<span class="params">query</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=&#x27;</span> + query;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">SearchResults</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="title function_">getFetchUrl</span>(<span class="string">&#x27;react&#x27;</span>);</span><br><span class="line">  &#125;, []); <span class="comment">// âœ… deps ç©ºçš„æ˜¯ OK çš„</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="title function_">getFetchUrl</span>(<span class="string">&#x27;redux&#x27;</span>);</span><br><span class="line">  &#125;, []); <span class="comment">// âœ… deps ç©ºçš„æ˜¯ OK çš„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¬¬<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:.64444em"></span><span class="strut bottom" style="height:.64444em;vertical-align:0"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span></span></span></span> ç¨®ï¼ŒæŠŠ function çµ¦è¨˜èµ·ä¾†ï¼Œç”±æ–¼æ¯æ¬¡ re-render éƒ½æœƒæ–°å»ºç«‹ functionï¼Œå¯ä»¥ä½¿ç”¨ <code>useCallback</code> è¨˜èµ·ä¾†ï¼Œä¸¦ä¸”æŒ‰ç…§å‚³å…¥çš„ deps å†é‡æ–°å»ºç«‹ functionï¼Œé¸æ“‡å†æœ‰å¿…è¦çš„æƒ…æ³å†æ›´æ–°ã€‚å¦‚æœæœ‰ä½¿ç”¨åˆ°ç›¸é—œçš„ state æˆ– props å°±èƒ½åŒæ­¥æ›´æ–°ã€‚</li></ul><ol><li>é¡ä¼¼æŠŠ function æåˆ°å¤–éƒ¨çš„è®ŠåŒ–å½¢æ…‹ :</li></ol><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// âœ… è·ŸæŠŠ function æåˆ°å¤–éƒ¨é¡ä¼¼ï¼Œä½†æ˜¯åœ¨ render function å…§è®“å®ƒä¸è®Š</span></span><br><span class="line"><span class="keyword">const</span> getFetchUrl = <span class="title function_">useCallback</span>(<span class="function">(<span class="params">query</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=&#x27;</span> + query;</span><br><span class="line">&#125;, []);  <span class="comment">// âœ… callback deps ç©ºçš„æ²’é—œä¿‚ï¼Œå› ç‚ºå®ƒæ˜¯é å¸¶å…¥çš„åƒæ•¸ä¾†è®ŠåŒ–</span></span><br><span class="line">  </span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="title function_">getFetchUrl</span>(<span class="string">&#x27;react&#x27;</span>);</span><br><span class="line">&#125;, [getFetchUrl]); <span class="comment">// âœ… deps æ”¾å…¥ getFetchUrl æ²’å•é¡Œï¼Œå› ç‚º getFetchUrl å»ºç«‹å¾Œä¸æœƒéš¨ re-render é‡æ–°å»ºç«‹</span></span><br><span class="line">  </span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="title function_">getFetchUrl</span>(<span class="string">&#x27;redux&#x27;</span>);</span><br><span class="line">&#125;, [getFetchUrl]);  <span class="comment">// âœ… deps æ”¾å…¥ getFetchUrl æ²’å•é¡Œï¼Œå› ç‚º getFetchUrl å»ºç«‹å¾Œä¸æœƒéš¨ re-render é‡æ–°å»ºç«‹</span></span><br></pre></td></tr></table></figure><ol start="2"><li>ä¾è³´å…§éƒ¨çš„ state æˆ– props</li></ol><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> [query, setQuery] = <span class="title function_">useState</span>(<span class="string">&#x27;react&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// âœ… getFetchUrl ç›´åˆ° query æœ‰æ”¹è®Šæ‰æœƒæ›´æ–°</span></span><br><span class="line"><span class="keyword">const</span> getFetchUrl = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=&#x27;</span> + query;</span><br><span class="line">&#125;, [query]);  <span class="comment">// âœ… callback deps æ ¹æ“š query state æ”¹è®Šè€Œé‡æ–°å»ºç«‹</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> url = <span class="title function_">getFetchUrl</span>();</span><br><span class="line">&#125;, [getFetchUrl]); <span class="comment">// âœ… deps æ˜¯ OK çš„ï¼Œè·Ÿ query æ˜¯åŒæ­¥æ›´æ–°</span></span><br></pre></td></tr></table></figure><p>è€Œ <code>useCallback</code> çš„æ–¹å¼ä¹Ÿé©ç”¨æ–¼çˆ¶å…ƒä»¶å‚³é function props çµ¦å­å…ƒä»¶çš„æ“ä½œ :</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Parent</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [query, setQuery] = <span class="title function_">useState</span>(<span class="string">&#x27;react&#x27;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// âœ… ç›´åˆ° query æ”¹è®Šæ‰é‡æ–°å»ºç«‹ fetchData</span></span><br><span class="line">  <span class="keyword">const</span> fetchData = <span class="title function_">useCallback</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=&#x27;</span> + query;</span><br><span class="line">  &#125;, [query]);  <span class="comment">// âœ… callback deps æ ¹æ“š query state æ”¹è®Šè€Œé‡æ–°å»ºç«‹</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* å‚³çµ¦å­å…ƒä»¶ï¼Œè¨˜ä½ ! é€™é‚Šçš„ function æ›´æ–°æ¢ä»¶æ˜¯ queryï¼Œæ‰€ä»¥å‚³å…¥çš„ fetchData æœƒä¸€ç›´æ˜¯åŒä¸€å€‹ */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Child</span> <span class="attr">fetchData</span>=<span class="string">&#123;fetchData&#125;</span> /&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">Child</span>(<span class="params">&#123; fetchData &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> [data, setData] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="title function_">fetchData</span>().<span class="title function_">then</span>(setData);</span><br><span class="line">  &#125;, [fetchData]); </span><br><span class="line">  <span class="comment">/* </span></span><br><span class="line"><span class="comment">  âœ… deps æ˜¯ OKï¼Œå› ç‚ºå®ƒä¹Ÿç­‰ Parent æœ¬èº« query æ”¹è®Šæ‰æœƒé‡æ–°å‘¼å«ï¼Œå…¶é¤˜çš„æ™‚å€™ Child æœ¬èº«ç„¡æ³•å‹•åˆ° effect çš„ï¼Œå³ä½¿ setData æ”¹è®Šäº†ï¼Œé€™è£¡ä¹Ÿä¸æœƒé‡æ–°å‘¼å« </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="function-æ˜¯è³‡æ–™æµçš„ä¸€ç¨®å—">function æ˜¯è³‡æ–™æµçš„ä¸€ç¨®å— ?</h2><p>é€™ç¯€æåˆ° function è®Šæˆ props å‚³éçµ¦å­å…ƒä»¶è¦æ³¨æ„çš„é»ï¼Œå¦å¤–å‡¸é¡¯ class component è·Ÿ function component ä¹‹é–“çš„å·®åˆ¥ã€‚</p><p><code>useEffect</code> æˆ‘å€‘çŸ¥é“æ˜¯åœ¨ render ä¹‹å¾Œæ‰å‘¼å«çš„ï¼Œè€Œä¸”å…·æœ‰ 3 ç¨®ä¸åŒæƒ…å¢ƒ :</p><ol><li>å®Œå…¨æ²’æœ‰ deps arrayï¼Œè¡¨ç¤ºåªè¦ re-render ä¹‹å¾Œå°±è·Ÿè‘—åŸ·è¡Œ</li><li>deps ç‚ºç©ºï¼Œè¡¨ç¤ºåªåœ¨ mount (render) ä¹‹å¾Œåªåšä¸€æ¬¡</li><li>deps æ”¾æœ‰ç›¸é—œè³‡æ–™ï¼Œè¡¨ç¤ºæœ‰é—œè³‡æ–™çš„æ”¹è®Šå°±æœƒé‡æ–°å‘¼å« effect</li></ol><p>çœ‹èµ·ä¾† <code>useEffect</code> æ˜¯ç­‰åŒæ–¼ class component ç”Ÿå‘½é€±æœŸä¸­çš„ <code>componentDidMount</code> ä»¥åŠ <code>componentDidUpdate</code> ğŸ¤”ğŸ¤”ğŸ¤”</p><p>åœ¨é€™ä¹‹å‰ï¼Œè¤‡ç¿’ä¸€ä¸‹ class component çš„ç”Ÿå‘½é€±æœŸåœ– :<br> <img data-src="https://i.imgur.com/cpFlaro.png" alt="|600x300"></p><ul><li>class component ä¸­å‚³é function propsï¼ŒæŠŠä¸Šé¢çš„ä¾‹å­è½‰æˆ class ç‰ˆæœ¬</li></ul><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Parent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="comment">// ç­‰åŒæ–¼ const [query, setQuery] = useState(&#x27;react&#x27;);</span></span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">query</span>: <span class="string">&#x27;react&#x27;</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// å®šç¾©äº† fetchData æ–¹æ³•</span></span><br><span class="line">  fetchData = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> url = <span class="string">&#x27;https://hn.algolia.com/api/v1/search?query=&#x27;</span> + <span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">query</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// function é€é props å‚³çµ¦ Child </span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Child</span> <span class="attr">fetchData</span>=<span class="string">&#123;this.fetchData&#125;</span> /&gt;</span></span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Child</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="comment">// ç­‰åŒæ–¼ä¸Šé¢ let [data, setData] = useState(null);</span></span><br><span class="line">  state = &#123;</span><br><span class="line">    <span class="attr">data</span>: <span class="literal">null</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// åœ¨ render ä¹‹å¾ŒåŸ·è¡Œ</span></span><br><span class="line">  <span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// å¾ Parent ä¾†çš„ï¼Œæˆ‘å€‘åƒ functional component ä¸€æ¨£åœ¨ render ä¹‹å¾Œå‘¼å«</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">fetchData</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€™æ¨£åœ¨ç¬¬ä¸€æ¬¡ render ä¹‹å¾Œç¢ºå¯¦å¯ä»¥åŸ·è¡Œï¼Œä½†æ˜¯æ²’è¾¦æ³•åœ¨ Parent props æ”¹è®Šæ™‚é‡æ–°å‘¼å«ã€‚</p><p>å¦‚æœè¦é‡æ–°å‘¼å« <code>this.props.fetchData</code>ï¼Œå°±æœƒåœ¨ <code>updating</code> éšæ®µ render å®Œå¾Œå‘¼å« <code>componentDidUpdate</code> ä¾†æª¢æŸ¥å‰å¾Œçš„ props æ˜¯å¦æœ‰æ”¹è®Šã€‚ç¢ºå¯¦è·Ÿ effect å¾ˆé¡ä¼¼ğŸ¤”</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">  <span class="comment">// âŒ é€™å€‹æ¢ä»¶æ°¸é ä¸æœƒæˆç«‹</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">fetchData</span> !== prevProps.<span class="property">fetchData</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">fetchData</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ props çš„æ¯”è¼ƒä¸æœƒæˆç«‹ï¼Œç‚ºä»€éº¼å‘¢ ?</p><blockquote><p>class component æ˜¯æ¯æ¬¡éƒ½é‡æ–°å‘¼å« <code>render()</code>è€Œå·²ï¼Œä¸¦ä¸æ˜¯ new é‡æ–°å»ºç«‹å¯¦ä¾‹ï¼Œå·²ç¶“è¢«å»ºç«‹çš„ function æ˜¯éœæ…‹çš„ã€‚</p></blockquote><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// class component</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">ComponentA</span> = <span class="keyword">new</span> <span class="title class_">Parent</span>()</span><br><span class="line"><span class="title class_">ComponentA</span>.<span class="title function_">render</span>() <span class="comment">// re-render æ˜¯æŒ‡å‘¼å« class ä¸­çš„ render function</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‰ prev ComponentA.method ç­‰æ–¼ next ComponentA.method</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// functional component</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">ComponentB</span>  = (<span class="params"></span>)=&gt;&#123;</span><br><span class="line">  <span class="keyword">return</span> ()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">re-render æ˜¯æŒ‡å‘¼å« ComponentB() æœ¬èº«ï¼Œå…¶å…§éƒ¨çš„ function éƒ½æœƒé‡æ–°å»ºç«‹ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="title class_">ComponentB</span>() </span><br><span class="line"></span><br><span class="line"><span class="comment">// ğŸ‘‰ prevComponentB ä¸ç­‰æ–¼ nextComponentB</span></span><br></pre></td></tr></table></figure><p>å¦‚æœæŠŠ <code>if</code> æ¢ä»¶æ‹”æ‰ï¼Œä¹Ÿæ˜¯éŒ¯èª¤çš„ã€‚å°è‡´æ¯æ¬¡ re-render éƒ½é‡æ–°å‘¼å« <code>fetchData()</code> ï¼Œè€Œä¸”æ˜¯ä¸è«– query æ˜¯ä¸æ˜¯æœ‰æ”¹è®Šï¼Œé€™ä¸æ˜¯æˆ‘å€‘è¦çš„æ•ˆæœã€‚</p><p>é‚£è®“æˆ‘å€‘çš„å‚³éä¸‹å»çš„ <code>fetchData</code> æ˜¯æœƒè·Ÿè‘— query è®ŠåŒ–çš„ï¼Œä½¿ç”¨ inline functionï¼Œä¸¦ä¸”ç”¨ <code>bind</code> ç¶å®šçˆ¶å±¤çš„ this ï¼Œé¿å…å‚³åˆ° Child å¾Œç”¨ this å°è‡´æŒ‡å‘ä¸æ­£ç¢ºçš„å•é¡Œã€‚</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Child</span> <span class="attr">fetchData</span>=<span class="string">&#123;this.fetchData.bind(this,</span> <span class="attr">this.state.query</span>)&#125; /&gt;</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€™æ¨£å°è‡´ <code>this.props.fetchData !== prevProps.fetchData</code> å§‹çµ‚æˆç«‹ï¼Œå°è‡´æ¯æ¬¡ re-render éƒ½é‡æ–°å‘¼å« <code>fetchData()</code> ã€‚</p><p>è§£æ±ºå•é¡Œçš„æ–¹æ³•ï¼Œå°±æ˜¯ <strong>æŠŠ query ç•¶ props è·Ÿè‘—å‚³ä¸‹å»</strong>ï¼Œ</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Parent Component</span></span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Child</span> <span class="attr">fetchData</span>=<span class="string">&#123;this.fetchData&#125;</span> <span class="attr">query</span>=<span class="string">&#123;this.state.query&#125;</span> /&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Child Component</span></span><br><span class="line"><span class="title function_">componentDidUpdate</span>(<span class="params">prevProps</span>) &#123;</span><br><span class="line">  <span class="comment">// æ ¹æ“š props.query æ±ºå®š</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">props</span>.<span class="property">query</span> !== prevProps.<span class="property">query</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">props</span>.<span class="title function_">fetchData</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>function å¯ä»¥è¢«å‚³éé€²å»ï¼Œä½†æ˜¯ function å…§éƒ¨çš„æ”¹è®Šèˆ‡å¦æ˜¯ä¸èƒ½è¢«çœ‹è¦‹çš„ï¼Œå®ƒæ²’è¾¦æ³•ç›´æ¥æ‹¿ä¾†è¢«æ¯”è¼ƒã€‚å¦ä¸€å€‹åŸå› æ˜¯ï¼Œprops å‚³ä¾†çš„æ–¹æ³•å°é–‰äº† <code>this</code> (this æ˜¯çœ‹æ€éº¼è¢«å‘¼å«ï¼Œä»€éº¼æ„æ€å‘¢ ? çœ‹ä¸‹é¢è¨»è§£)ï¼Œæˆ‘å€‘ä¸èƒ½ç›´æ¥ä¾è³´å®ƒä¾†æ±ºå®šæ˜¯å¦æ›´æ–°ã€‚å°è‡´æˆ‘å€‘ <strong>å¿…é ˆå‚³éå…§éƒ¨ç›¸é—œæ‰€æœ‰çš„è³‡æ–™</strong>ï¼Œå°±ç‚ºäº†æª¢æŸ¥æ˜¯å¦æœ‰æ”¹è®Šå†æ±ºå®šè¦ä¸è¦å‘¼å«æ–¹æ³•ã€‚</p><blockquote><p>å°æ–¼ class component ä¾†èªªï¼Œ function props ä¸æ˜¯å±¬æ–¼è³‡æ–™æµçš„ä¸€éƒ¨åˆ†ã€‚</p></blockquote><p>æˆ‘å€‘ä¸çŸ¥é“ <code>this.props.fetchData</code> å¾ Parent å‚³éä¾†æ˜¯ä¸æ˜¯è·Ÿ state æœ‰é—œï¼Œæˆ–æ˜¯ state æ˜¯ä¸æ˜¯å·²ç¶“æ”¹è®Šäº†ã€‚(é€™å€‹ props çš„ stateless æœ‰é—œå— ? )</p><p>ä½¿ç”¨ <code>useCallback</code> è®“ function å¯ä»¥åŠ å…¥è³‡æ–™æµä¸­ï¼Œæˆ‘å€‘æ ¹æ“š function çš„è¼¸å…¥å€¼æ”¹è®Šï¼Œä»£è¡¨ function æœ¬èº«ä¹Ÿè¦æ”¹è®Šï¼Œåä¹‹äº¦ç„¶ï¼Œè¼¸å…¥æ²’æœ‰è®Šçš„è©±å°±ä¹Ÿä¸æœƒç”¢ç”Ÿæ–°çš„ functionã€‚æœ‰ <code>useCallback</code> çš„å”åŠ©ï¼Œæ”¹è®Š props çš„æ™‚å€™ï¼Œ<code>props.fetchData</code> ä¹Ÿæœƒè‡ªå‹•åœ°å‚³éä¸‹å»ï¼Œå› ç‚ºå®ƒæœ¬èº«æ˜¯è³‡æ–™æµçš„ä¸€éƒ¨åˆ†ã€‚</p><h3 id="æ³¨æ„-4">æ³¨æ„</h3><p>æŠŠä»»ä½• function éƒ½åŠ ä¸Š <code>useCallback</code> æ˜¯ä¸€ä»¶å¾ˆä¸ Ok çš„äº‹ï¼Œé€™ä¸æ˜¯ä¿è­‰æ˜¯æ•ˆèƒ½ä¸Šçš„å„ªåŒ–ã€‚</p><p>é›–ç„¶å®ƒæ˜¯ä¸€å€‹å¾ˆæœ‰æ•ˆçš„æ–¹æ³•ï¼Œå°æ–¼åŒæ™‚å‚³éçµ¦å¤šå€‹å­å…ƒä»¶ï¼Œä¸¦ä¸”æ‡‰ç”¨åœ¨å­å…ƒä»¶å…§éƒ¨çš„ effectï¼Œæ˜¯å¯ä»¥é¿å…å­å…ƒä»¶åšç„¡æ„ç¾© render çš„å•é¡Œã€‚ç•¶ç„¶ä¹Ÿå¯ä»¥åŒ…è£¹æˆ Hooks é¿å…å¤šå€‹ callbacks å‚³éæ•´å€‹ React æ¨¹ç‹€çµæ§‹ã€‚</p><p>ç”¨ä¸Šé¢çš„ <code>fetchData</code> ä¾†è©¦è‘—å¯«æˆ <code>useFetchData</code> ï¼Œé€™è£¡å¯ä»¥æ­é… <code>useContext</code>ï¼Œä½¿ç”¨ Provider åŒ…ä½çš„å…ƒä»¶å¯ä»¥æ ¹æ“š query æ”¹è®Šè€Œæ›´æ–°è³‡æ–™åŒ…ã€‚<br> ğŸ‘‰ <a href="https://codesandbox.io/s/festive-fermi-1cms7c?file=/src/index.js">codesandbox ç°¡æ˜“æŸ¥è©¢å„åœ‹ä»£ç¢¼ API</a></p><p>åˆ—å‡ºåŠŸèƒ½ :</p><ol><li>Provider åŒ…ä½çš„å…ƒä»¶ï¼Œä½¿ç”¨ <code>useFetchData</code> å°±å¯ä»¥æ‹¿åˆ°å›å‚³çš„è³‡æ–™ã€‚</li><li>ç•¶ query æ”¹è®Šæ™‚é‡æ–°ç²å–è³‡æ–™</li></ol><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createContext, useMemo, useState, useEffect, useContext &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºæœ¬ç¶²å€</span></span><br><span class="line"><span class="keyword">let</span> baseurl = <span class="string">&quot;https://restcountries.com/v3.1/name/&quot;</span>;</span><br><span class="line"><span class="comment">// å»ºç«‹ contextï¼Œå¦‚æ­¤ä¸€ä¾†åŒ…ä½çš„å…ƒä»¶éƒ½å¯ä»¥ç›´æ¥ç”¨ useFetchData å–çš„å…±äº«å€¼</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Context</span> = <span class="title function_">createContext</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="comment">// ä¿®ä¸€ä¸‹åå­—æ–¹ä¾¿ debug</span></span><br><span class="line"><span class="title class_">Context</span>.<span class="property">displayName</span> = <span class="string">&quot;FetchDataContext&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å»ºç«‹ Provider å…ƒä»¶</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">DataProvider</span>(<span class="params">&#123; children &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [query, setQuery] = <span class="title function_">useState</span>(<span class="string">&quot;tw&quot;</span>);</span><br><span class="line">  <span class="comment">// é¿å…é€ æˆ value re-render ï¼ŒæŠŠ value è¨˜æ†¶èµ·ä¾†ï¼Œç›´åˆ°æ”¹è®Š query</span></span><br><span class="line">  <span class="keyword">const</span> value = <span class="title function_">useMemo</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      query,</span><br><span class="line">      setQuery</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [query]);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">Context.Provider</span> <span class="attr">value</span>=<span class="string">&#123;value&#125;</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">Context.Provider</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Custom Hooks </span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">useFetchData</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// é€™ä¸€æ®µä¸»è¦ç¢ºèªä¸Šæ–¹æ˜¯å¦æœ‰ Provider çš„é˜²å‘†</span></span><br><span class="line">  <span class="keyword">const</span> context = <span class="title function_">useContext</span>(<span class="title class_">Context</span>);</span><br><span class="line">  <span class="keyword">if</span> (context === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;useCount must be used within a CountProvider&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç¢ºå®šæœ‰å¾ŒæŠŠ context è§£æ§‹æ¯”è¼ƒå¥½è®€</span></span><br><span class="line">  <span class="keyword">const</span> &#123; query, setQuery &#125; = context;</span><br><span class="line">  <span class="comment">// è®€å–å›ä¾†çš„è³‡æ–™</span></span><br><span class="line">  <span class="keyword">const</span> [data, setData] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  <span class="comment">// éŒ¯èª¤è™•ç†</span></span><br><span class="line">  <span class="keyword">const</span> [message, setMessage] = <span class="title function_">useState</span>(<span class="literal">null</span>);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (query) &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(baseurl + query).<span class="title function_">then</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="title function_">json</span>());</span><br><span class="line">        <span class="comment">// å›å‚³ä¸æ˜¯ 404 æ™‚åˆ¤æ–·</span></span><br><span class="line">        <span class="keyword">if</span> (!data.<span class="property">status</span>) &#123;</span><br><span class="line">          <span class="title function_">setData</span>(data);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// å›å‚³ status ç‚º 404 è¨­å®šéŒ¯èª¤è³‡è¨Š</span></span><br><span class="line">          <span class="title function_">setMessage</span>(data.<span class="property">message</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="title function_">setMessage</span>(<span class="literal">null</span>); <span class="comment">// æ¸…é™¤éŒ¯èª¤è³‡è¨Š</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [query]); <span class="comment">// ğŸ‘ˆ deps æ”¾å…¥ query</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å›å‚³éœ€è¦çš„å€¼</span></span><br><span class="line">  <span class="keyword">return</span> &#123; data, query, setQuery, message &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰“åŒ…å›å‚³</span></span><br><span class="line"><span class="keyword">export</span> &#123; <span class="title class_">DataProvider</span>, useFetchData &#125;;</span><br></pre></td></tr></table></figure><p>å¯«æˆ Hooks æ™‚åœ¨ä½¿ç”¨å°±å¾ˆæ–¹ä¾¿ï¼Œåªè¦åœ¨åŒä¸€å±¤å…±äº«çš„éƒ¨ä»½åŠ ä¸Š Provider ï¼Œå…§éƒ¨å…ƒä»¶éƒ½ä½¿ç”¨ <code>useFetchData</code> å°±èƒ½æ‹¿åˆ°æƒ³è¦çš„å…§å®¹ğŸ‘</p><p>ç•¶ç„¶é€™å€‹ä¾‹å­å¯ä»¥å†æ”¹é€²ï¼Œä¾‹å¦‚ input çš„éƒ¨ä»½å¯ä»¥æ”¹ç”¨ optionï¼Œç”±ç¬¬ä¸€æ¬¡é€²å…¥ app å…ˆå–å¾—æ‰€æœ‰åœ‹å®¶åœ‹ç¢¼ï¼Œé€™æ¨£ä½¿ç”¨è€…å¯ä»¥ç”¨é¸å–®çš„æ–¹å¼é€²è¡Œã€‚</p><h2 id="è«‡è«‡ç«¶çˆ­æ¢ä»¶-race-condition">è«‡è«‡ç«¶çˆ­æ¢ä»¶ (race condition)</h2><p>ä»€éº¼æ˜¯ç«¶çˆ­æ¢ä»¶å‘¢ ?</p><p>åœ¨ JavaScript ä¸­è·Ÿç«¶çˆ­æ¢ä»¶æœ‰é—œçš„æ˜¯éåŒæ­¥çš„å•é¡Œï¼Œå¦‚ä¸Šé¢èˆ‰ä¾‹çš„ <code>fetchData</code> ã€‚<strong>å¦‚æœåœ¨éåŒæ­¥æ“ä½œçš„æœªå®Œæˆçš„æ™‚å€™ï¼Œä¸­é€”æ”¹è®Š state æˆ– props æœƒå°è‡´éé æœŸçš„äº‹æƒ…ç™¼ç”Ÿã€‚</strong><br> ğŸ‘‰ å¯ä»¥åƒè€ƒé€™ç¯‡æ–‡ç«  : <a href="https://toy9986619.medium.com/javascript-async-await-%E7%9A%84-race-condition-20927705569">JavaScript â€” async/await çš„ race condition</a></p><blockquote><p>ç°¡å–®ä¾†èªªè·ŸåŸ·è¡Œé †åºæœ‰é—œ</p></blockquote><p>ä»¥ <code>fetchData</code> ç‚ºä¾‹ï¼Œæˆ‘å€‘ç”¨ async/await ç°¡åŒ–éåŒæ­¥çš„è™•ç†ï¼Œå…§éƒ¨çš„ fetch æ˜¯ Promiseï¼Œå¦‚æœåœ¨ pending çš„æ™‚å€™åˆæ”¹è®Š state é‡æ–°ç²å–è³‡æ–™ï¼Œå°±æœƒç™¼ç”Ÿå•é¡Œã€‚</p><p>ä¾‹å¦‚ : ä¸€é–‹å§‹æœå°‹ usaï¼Œåœ¨çµæœé‚„æ²’è¿”å›æ™‚æ”¹æˆ peruï¼Œå‡è¨­ usa è³‡æ–™å…ˆå›ä¾†ä¸¦ä¸”é¡¯ç¤ºåœ¨ç•«é¢ä¸Šï¼Œéä¸€ä¸‹å­æœ€çµ‚ peru çš„ response æ‰æœƒå›ä¾† ã€‚<strong>ç•«é¢ç­‰å¾… peru è³‡æ–™å›å‚³æ™‚é¡¯ç¤º usa è³‡æ–™çš„æ™‚å€™ input æ˜¯ peru å‘€ !</strong> é€ æˆ UI è·Ÿ state å°ä¸ä¸Šäº†ğŸ˜µã€‚</p><p>å¦‚æœè¦æ¨¡ä»¿æ­¤å‹•ä½œï¼Œå¯ä»¥åˆ° devtool çš„ network ä¸¦ä¸”è‡ªè¨‚é€Ÿåº¦ï¼Œé€™é‚Šæˆ‘è¨‚äº†ä¸€å€‹å« <code>superslow</code>ï¼ŒæŠŠ Download è¨­ç‚º 1kbï¼Œè®“å›å‚³é–“éš”è®Šé•·å°±æ¯”è¼ƒæ¸…æ¥šå•é¡Œã€‚<br> <img data-src="https://i.imgur.com/Hh8l045.png" alt="|400x220"></p><p>æ€éº¼é¿å…æˆ–æ˜¯è§£æ±ºæ­¤ç‹€æ³å‘¢ ? ğŸ¤”</p><p>è¦çŸ¥é“ React çš„ <code>useEffect</code> ä¸¦ä¸æœƒå¹«æˆ‘å€‘è™•ç†é€™å€‹å•é¡Œï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯å¯ä»¥è®“éåŒæ­¥è¢«ä¸­æ–· (abort)ï¼Œä¸¦ä¸”åœ¨ clean up çš„éšæ®µå–æ¶ˆã€‚å¦å¤–ä¸€å€‹æ–¹æ³•æ˜¯ï¼Œ<strong>åœ¨æŠŠå›å‚³è³‡æ–™æ”¾å…¥ state ä¹‹å‰ï¼Œç”¨ <code>boolean</code> æª¢æŸ¥ç›®å‰ç‹€æ…‹æ˜¯å¦è¦å–æ¶ˆã€‚</strong> å› ç‚ºåœ¨åŸ·è¡Œä¸‹ä¸€å€‹ effect ä¹‹å‰ï¼Œæœƒå…ˆåŸ·è¡Œ clean up functionã€‚</p><p>æ—¢ç„¶æˆ‘å€‘ä¸Šé¢æœ‰å¯¦ä½œï¼Œé‚£å°±ä¾†æ”¹é€ ä¸Šé¢çš„ä¾‹å­ :</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">useEffect</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// ğŸ‘‰ å»ºç«‹ç•¶æ¬¡ render çš„ didCancel</span></span><br><span class="line">    <span class="keyword">let</span> didCancel = <span class="literal">false</span>;</span><br><span class="line">    (<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (query) &#123;</span><br><span class="line">        <span class="keyword">const</span> data = <span class="keyword">await</span> <span class="title function_">fetch</span>(baseurl + query).<span class="title function_">then</span>(<span class="function">(<span class="params">r</span>) =&gt;</span> r.<span class="title function_">json</span>());</span><br><span class="line">        <span class="comment">// æª¢æŸ¥æ˜¯ä¸æ˜¯æœ‰å–æ¶ˆ ?</span></span><br><span class="line">        <span class="keyword">if</span> (!didCancel) &#123;</span><br><span class="line">          <span class="title function_">setData</span>(data);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">setMessage</span>(data.<span class="property">message</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)();</span><br><span class="line">    <span class="keyword">return</span> <span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// åœ¨ä¸‹ä¸€å€‹ effect åŸ·è¡Œå‰ï¼Œç¢ºå®šå–æ¶ˆ</span></span><br><span class="line">      didCancel = <span class="literal">true</span>;</span><br><span class="line">      <span class="title function_">setMessage</span>(<span class="literal">null</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [query]);</span><br></pre></td></tr></table></figure><p>æƒ…å¢ƒ :</p><ol><li>é¡¯ç¤ºç•«é¢å¾Œæ”¹æœå°‹ usa</li><li>è³‡æ–™é‚„æ²’è¿”å›ï¼Œæ”¹æˆ peru</li></ol><p>æˆ‘å€‘ä¾†åŸ·è¡Œçœ‹çœ‹ï¼Œå¾ç¬¬ä¸€æ¬¡ render å®Œä¹‹å¾Œ :</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input æ”¹æˆ usa</span></span><br><span class="line">setState query = <span class="string">&quot;usa&quot;</span></span><br><span class="line">re-render <span class="variable constant_">UI</span></span><br><span class="line"></span><br><span class="line">clean up æ¸…é™¤ tw å‰¯ä½œç”¨</span><br><span class="line">  state query <span class="string">&quot;tw&quot;</span></span><br><span class="line">  didCancel = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">effect åŸ·è¡Œ</span><br><span class="line">  state query <span class="string">&quot;usa&quot;</span></span><br><span class="line">  didCancel = <span class="literal">false</span></span><br><span class="line">  ğŸš€<span class="keyword">async</span> <span class="keyword">function</span> åŸ·è¡Œï¼Œé€²å…¥ pending ç‹€æ…‹</span><br><span class="line"></span><br><span class="line"><span class="comment">// input æ”¹æˆ peru</span></span><br><span class="line">  setState query = <span class="string">&quot;peru&quot;</span></span><br><span class="line">  re-render <span class="variable constant_">UI</span></span><br><span class="line"></span><br><span class="line">clean up æ¸…é™¤ usa å‰¯ä½œç”¨</span><br><span class="line">  state query <span class="string">&quot;usa&quot;</span></span><br><span class="line">  didCancel = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">effect åŸ·è¡Œ</span><br><span class="line">  state query <span class="string">&quot;peru&quot;</span></span><br><span class="line">  didCancel = <span class="literal">false</span></span><br><span class="line">  ğŸš€<span class="keyword">async</span> <span class="keyword">function</span>  åŸ·è¡Œï¼Œé€²å…¥ pending ç‹€æ…‹</span><br><span class="line"></span><br><span class="line">ğŸ‘‰ usa è³‡æ–™å›ä¾†äº†</span><br><span class="line">  usa clean effect å·²ç¶“è¢«å‘¼å«ï¼Œæ­¤æ™‚ didCancel æ˜¯ <span class="literal">true</span> ğŸ˜µ</span><br><span class="line">  âŒ setData ä¸æœƒè¢«åŸ·è¡Œ</span><br><span class="line"></span><br><span class="line">ğŸ‘‰ æœ€å¾Œ peru è³‡æ–™å›ä¾†äº†</span><br><span class="line">  didCancel æ˜¯ <span class="literal">false</span> </span><br><span class="line">  setData æœƒåŸ·è¡Œ</span><br><span class="line">  é¡¯ç¤º peru è³‡æ–™</span><br></pre></td></tr></table></figure><p>ä¸€é–‹å§‹å¾ä¸Šé¢çœ‹èµ·ä¾† <code>usa</code> è³‡æ–™å›ä¾†ç‚ºä»€éº¼ <code>didCancel = true</code> ğŸ¤”ï¼Œæ˜æ˜ <code>peru</code> çš„ effect åŸ·è¡Œäº† <code>didCancel = false</code>ã€‚å›åˆ°é †åºå•é¡Œï¼Œåœ¨ <code>usa</code> é€™å€‹ render æ™‚ï¼Œæˆ‘å€‘çš„ <code>didCancel</code> æœ€å¾Œæ˜¯ä»€éº¼ ?</p><p>æˆ‘ä¸€é–‹å§‹è¦ºå¾—å¾ˆå¾®å¦™ï¼Œæ‰€ä»¥å†å›å»è¤‡ç¿’ [[#è«‡è«‡ clean up]] é€™å€‹ç« ç¯€ã€‚</p><blockquote><p>æ¯ä¸€å€‹åœ¨ render å…§éƒ¨å‘¼å«çš„ function (åŒ…å« handlers ã€effect ç­‰ç€è¦½å™¨ APIs )ï¼Œéƒ½æœƒæ‹¿åˆ°ç•¶ä¸‹å®šç¾©çš„ state ã€‚</p></blockquote><p>å–®çœ‹åœ¨ <code>usa</code> é€™æ¬¡ render åŸ·è¡Œé †åºæ‡‰è©²æ˜¯ :</p><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">usa-didCancel = <span class="literal">false</span></span><br><span class="line">ğŸš€<span class="keyword">async</span> <span class="keyword">function</span> é€²è¡Œ fetch data</span><br><span class="line">  </span><br><span class="line">peru çš„åˆ°ä¾†è§¸ç™¼äº† use-clean up <span class="keyword">function</span></span><br><span class="line">  usa-didCancel = <span class="literal">true</span></span><br><span class="line">  </span><br><span class="line">usa è³‡æ–™å›ä¾† data = ...</span><br><span class="line"><span class="keyword">if</span> (usa-didCancel = <span class="literal">true</span>)</span><br><span class="line">âŒ setData é€™è¡Œä¸æœƒè¢«åŸ·è¡Œ</span><br></pre></td></tr></table></figure><p>åœ¨é‡æ¸…æ¦‚å¿µçš„éç¨‹ï¼Œæˆ‘æ˜¯ä½¿ç”¨ console åœ¨æ¯ä¸€å€‹éšæ®µå°å‡ºç•¶æ™‚çš„ query ï¼Œå¹«åŠ©è‡ªå·±äº†è§£ effect ä¸€å€¼æåˆ°çš„ <strong>åŒæ­¥</strong> æ¦‚å¿µ</p><h2 id="ç”¨æ­£ç¢ºçš„å¿ƒæ…‹å°å¾…-useEffect">ç”¨æ­£ç¢ºçš„å¿ƒæ…‹å°å¾… useEffect</h2><p><code>useEffect</code> é›–ç„¶å¾ˆå¸¸è¢«ç”¨åœ¨éåŒæ­¥è®€å–è³‡æ–™ï¼Œä½† <strong><code>useEffect</code> æ˜¯æ ¸å¿ƒæ€æƒ³æ˜¯ä¾†åšåŒæ­¥çš„æ“ä½œ</strong>ã€‚ side effects è®Šæˆè³‡æ–™æµçš„ä¸€éƒ¨åˆ†ï¼Œåªè¦æˆ‘å€‘çš„ç•¶æ¬¡ render çš„è³‡æ–™åŒæ­¥ï¼Œå–å¾—çš„è³‡æ–™ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼Œå°æ–¼é‚Šéš›æ¢ä»¶ (edge case) çš„è™•ç†å°±æœƒæ¯”è¼ƒå®¹æ˜“ã€‚</p><p>ä¸é React åœ¨ 18 ç‰ˆæœ¬å°æ–¼è™•ç†éåŒæ­¥äº‹ä»¶æ¯”è¼ƒå»ºè­°ä½¿ç”¨ <strong>Suspense</strong>ã€‚Suspense æ˜¯ä¸€å€‹å¯ä»¥è®“é‚„æ²’æº–å‚™å¥½å¯ä»¥ render çš„ UI å¯ä»¥é¡¯ç¤ºé è¨­çš„ Component ï¼Œä¸»è¦è¦è§£æ±º 2 å€‹å•é¡Œ</p><ol><li>code splitting : ä¸ç”¨æŠŠä¸€æ¬¡æ‰€æœ‰ app å…ƒä»¶è¼‰ä¸‹ä¾†ï¼Œè€Œæ˜¯è¼‰å¿…è¦çš„</li><li>data fetching : è§£æ±ºåƒæ˜¯ä¸Šé¢æåˆ°çš„ race condition å•é¡Œ</li></ol><p>ä¸é Suspense æˆ‘ä¹Ÿé‚„æ²’èªçœŸç ”ç©¶é ğŸ˜µï¼Œå…ˆåˆ—å…¥è£œå‘å¤§éšŠçš„åå–®å§</p><h2 id="ç¸½çµ-33">ç¸½çµ</h2><ol><li><code>useEffect</code> æ˜¯ render èˆ‡ç€è¦½å™¨ painting ä¹‹å¾ŒåŸ·è¡Œï¼Œç›®çš„æ˜¯ä¸é˜»æ””è¢å¹•çš„æ›´æ–°ã€‚</li><li><code>useEffect</code> deps array å¦‚æœæ˜¯ç©ºçš„ï¼Œåƒ…åŸ·è¡Œä¸€æ¬¡ï¼Œå¦‚æœ array æœ‰ state æˆ– props ï¼Œæ ¹æ“šè³‡æ–™æ˜¯å¦æœ‰æ”¹è®Šï¼Œæœƒè·Ÿè‘—ç•¶æ¬¡ render ä¹‹å¾Œé‡æ–°å‘¼å«ã€‚</li><li>æ¯ä¸€æ¬¡ render éƒ½ä¿æœ‰å®ƒæ‰€æœ‰çš„æ±è¥¿ï¼ŒåŒ…å« event handlerã€éåŒæ­¥ (async/await)ã€effect æˆ–æ˜¯ API ï¼Œä»¥åŠç•¶æ¬¡ render çš„ state èˆ‡ propsã€‚</li><li>æƒ³æ‹¿åˆ°æœ€æ–°çš„å€¼å¯ä»¥ä½¿ç”¨ <code>refs</code>ï¼Œrefs å°±åƒæ”¾åœ¨å¤–éƒ¨çš„ç›’å­ï¼ŒReact ç¢ºä¿å®ƒéƒ½æŒ‡å‘åŒä¸€è¨˜æ†¶é«”ä½å€ï¼Œæ”¹è®Šå…¶å€¼ä¹Ÿä¸æœƒé€ æˆ re-renderã€‚</li><li>clean up function æœƒåœ¨ä¸‹ä¸€å€‹ effect å‘¼å«ä¹‹å‰å…ˆåŸ·è¡Œï¼Œæ³¨æ„ clean up æ‰€æ¸…é™¤çš„æ˜¯ä¸Šä¸€æ¬¡ render çš„å€¼ã€‚</li><li>ä¸è¦æ¬ºé¨™ deps arrayï¼Œé€šå¸¸ lint æœƒæé†’ï¼Œä½†æ˜¯é‡åˆ° object type çš„å€¼è¦å°å¿ƒï¼Œå¯èƒ½é€ æˆéåº¦é »ç¹æ›´æ–°ã€‚</li><li><code>useEffect</code> çš„ deps array æ˜¯å¦è¦æ”¾å…¥ç›¸é—œ state æˆ– props ï¼Œå¯ä»¥è¦– effect function ä¸­çš„ state è®ŠåŒ–æ˜¯å¦å¯ç”± <code>prevState</code> æ¨æ¸¬å‡ºä¾†ï¼Œå¦‚æœå¯ä»¥å¯ä½¿ç”¨ updater function ä¾†æ›´æ–°ã€‚</li><li>useReducer æ˜¯å¯ä»¥è®“è³‡æ–™è·Ÿé‚è¼¯åˆ†é–‹æ“ä½œçš„å¥½æ–¹æ³•ã€‚</li><li><code>useCallback</code> æ˜¯å¯ä»¥è¨˜ä½ render å…§çš„ functionï¼Œä½¿å…¶æ¯æ¬¡ä¸æ‡‰ re-render è€Œé‡æ–°å»ºç«‹ï¼Œæˆ–æ˜¯é€é callback çš„ deps array ä¾†å„ªåŒ–ã€‚å¦‚æœä¸æ˜¯ function å‰‡å¯ä»¥ä½¿ç”¨ <code>useMemo</code> è¨˜ä½æŸå€¼ã€‚</li><li>function åœ¨ function component èˆ‡ Hooks ä¸­æ˜¯ä¸€ç¨®è³‡æ–™æµã€‚å®ƒå¯ä»¥é€é props ä¾†å‚³éï¼Œä¹Ÿå¯ä»¥è¢«åˆ¤æ–·æ˜¯å¦ç‚º render çš„æ¢ä»¶ä¹‹ä¸€ã€‚è¨˜ä½ï¼Œæ­¤è¡Œç‚ºè·Ÿ class component ä¸ä¸€æ¨£ã€‚</li><li>useEffect æ˜¯è™•ç†åŒæ­¥çš„æ“ä½œï¼Œç¢ºä¿æ¯ä¸€æ¬¡ render çš„ state æˆ– props èˆ‡ UI å…·æœ‰ä¸€è‡´æ€§ã€‚</li></ol><p>æœ¬ç¯‡é›–ç„¶è‘—é‡æ–¼ <code>useEffect</code> ï¼Œä½†å°æ–¼æ–°æ‰‹ä¸€é€£è²«èªè­˜ React æ¦‚å¿µé‡æ¸…å¾ˆæœ‰å¹«åŠ©ã€‚è®€å®Œå¯ä»¥èªªæ˜¯é†é†çŒé ‚ï¼Œå¾ class Component åˆ° function Component çš„è½‰è®Šï¼Œå…¶è§£æ±ºçš„åŸå› ï¼›function Component ä½¿ç”¨çš„å¿ƒæ™ºæ¨¡å‹ (ä¹Ÿå°±æ˜¯æ ¸å¿ƒæ¦‚å¿µ)ï¼Œæ›´äº†è§£ Hooks çš„æ€ç¶­èˆ‡çµåˆ JavaScript closure çš„å¥§å¦™ï¼Œè®“äººè®€å®Œæœ‰ä¸€ç¨®</p><blockquote><p>ã€ŒåŸä¾†æ˜¯é€™æ¨£çš„é˜¿ !ã€</p></blockquote><p>é›–ç„¶é–±è®€éç¨‹å¾ˆè‰±è¾›ğŸ˜µï¼Œå› ç‚ºæˆ‘æ˜¯ç”Ÿå•ƒè‹±æ–‡ç‰ˆï¼Œæ²’æœ‰é¸æ“‡ä¸­æ–‡æ˜¯æ“”å¿ƒç„¡æ³•é ˜æœƒç¿»è­¯è€…çš„æ„æ€ï¼Œä¸æ˜¯æ€•ç¿»ä¸å¥½ï¼Œè€Œæ˜¯æ“”å¿ƒç¿»è­¯è€…æ°´å¹³å¤ªé«˜ï¼Œåè€Œæˆ‘çœ‹ä¸æ‡‚ğŸ¤£ã€‚å¹¸å¥½ Dan å¤§çš„æ–‡ç« æœ¬èº«å°å°ç™½å¾ˆå‹å–„ï¼Œå¾ˆå€¼å¾—ç”¨åŸæ–‡ä¸€è®€ğŸ‘</p><h3 id="é¡Œå¤–è©±">é¡Œå¤–è©±</h3><p>é€™æ®µæœŸé–“æ ¡æ­£æœ¬ç¯‡æ–‡ç« æ™‚ï¼ŒFB ç¤¾åœ˜ <a href="https://www.facebook.com/groups/reactjs.tw/">ReactJS.tw</a> ä¹Ÿæ­£å¥½æœ‰å¤§ç¥åšåŒæ¨£çš„ä¸»é¡Œ <a href="https://slides.com/tz5514/useeffect-guide?fbclid=IwAR2VdZODJPO8Ex1Kd7PksCRA4dakIVvY-4aJ3X3ZtgfSwgq7hOGE6qHvcNc">éƒ½ 2022 å¹´äº†ä½ é‚„æ˜¯å¯èƒ½ä¸æ‡‚ useEffect</a>ã€‚æ•´ç†å‡ºçš„è„ˆçµ¡æ¸…æ™°ï¼Œä¹Ÿæœ‰æåˆ° React 18 ç‚ºä»€éº¼åš´æ ¼æ¨¡å¼æœƒåŸ·è¡Œå…©æ¬¡çš„å•é¡Œã€‚ç›®å‰æˆ‘é‚„æ²’å®Œå…¨çœ‹å®Œï¼Œä½†æˆ‘èªç‚ºçœ‹ä¸åŒçš„äººè§£é‡‹åŒç¯‡æ–‡ç« ä¹Ÿæ˜¯å¾ˆæœ‰å€¼å¾—å­¸ç¿’çš„åœ°æ–¹ï¼Œç•¢ç«Ÿæ–°æ‰‹è·Ÿè€æ‰‹çš„èªçŸ¥èµ·é»ä¸åŒğŸ˜‚ï¼Œå¾ˆæ…¶å¹¸æ­£å¥½åœ¨å­¸ç¿’ useEffect åŒæ™‚é‡åˆ°å¤§ç¥çš„ç°¡å ±èˆ‡æ¼”è¬›ï¼Œé‡åˆ°è§€å¿µå¡ä½æ™‚ï¼Œæˆ‘ä¹Ÿæœƒç¿»åˆ°å¤§ç¥çš„ç°¡å ±å»å½Œè£œæˆ‘ä¸æ‡‚çš„åœ°æ–¹ã€‚</p><p>æœ‰ä¸€åº¦æƒ³ä»¥ç°¡å ±çš„å…§å®¹å»é‡æ–°æ•´ç†æ–‡ç« ï¼Œä½†æƒ³æƒ³é€™ä¹Ÿæˆ‘å­¸ç¿’ useEffect çš„åŸæ±åŸå‘³å­¸ç¿’éç¨‹ï¼Œå°±å…¨ä¿ç•™äº†ğŸ¤“ã€‚</p><div id="footnotes"><hr><div id="footnotelist"><ol style="list-style:none;padding-left:0"><li id="fn:1"><span style="display:inline-block;vertical-align:top;padding-right:10px">1.</span><span style="display:inline-block;vertical-align:top">render å…§éƒ¨ function çš„åŸ·è¡Œé» : <a href="https://codesandbox.io/s/w2wxl3yo0l">w2wxl3yo0l - CodeSandbox</a></span> <a href="#fnref:1" rev="footnote">â†©</a></li><li id="fn:2"><span style="display:inline-block;vertical-align:top;padding-right:10px">2.</span><span style="display:inline-block;vertical-align:top">function ç‰ˆæœ¬ : setTimeout ä¹‹ä¾åºå°å‡º state <a href="https://codesandbox.io/s/lyx20m1ol">lyx20m1ol - CodeSandbox</a></span> <a href="#fnref:2" rev="footnote">â†©</a></li><li id="fn:3"><span style="display:inline-block;vertical-align:top;padding-right:10px">3.</span><span style="display:inline-block;vertical-align:top">class ç‰ˆæœ¬ : setTimeout ä¹‹å…¨éƒ¨åŒæ™‚ä¸€æ¨£çš„ state <a href="https://codesandbox.io/s/kkymzwjqz3">kkymzwjqz3 - CodeSandbox</a></span> <a href="#fnref:3" rev="footnote">â†©</a></li><li id="fn:4"><span style="display:inline-block;vertical-align:top;padding-right:10px">4.</span><span style="display:inline-block;vertical-align:top"><a href="https://reactjs.org/docs/hooks-reference.html#functional-updates">Hooks API Reference â€“ React â€“ functional-updates</a></span> <a href="#fnref:4" rev="footnote">â†©</a></li></ol></div></div></div><div class="popular-posts-header">ç›¸é—œæ–‡ç« </div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="\2022\04\04\Practice-to-Master-01.html" rel="bookmark">ç´€éŒ„ | Frontend Mentor æŒ‘æˆ°é¡Œ - Time tracking dashboard</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\2022\07\React\ContextAPI.html" rel="bookmark">ç­†è¨˜ | React - Context API</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\2022\07\React\Higher-Order-Component.html" rel="bookmark">ç­†è¨˜ | React - Higher Order Component (HOC)</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\2022\07\React\Render-props.html" rel="bookmark">ç­†è¨˜ | React - render props</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="\2022\08\React\ref-and-callback-ref.html" rel="bookmark">ç­†è¨˜ | React - ref èˆ‡ callback ref</a></div></li></ul><footer class="post-footer"><div class="post-tags"><a href="/tags/React/" rel="tag"><i class="fa fa-tag"></i> React</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2022/07/React/Render-props" rel="prev" title="ç­†è¨˜ | React - render props"><i class="fa fa-chevron-left"></i> ç­†è¨˜ | React - render props</a></div><div class="post-nav-item"> <a href="/2022/08/React/ref-and-callback-ref" rel="next" title="ç­†è¨˜ | React - ref èˆ‡ callback ref">ç­†è¨˜ | React - ref èˆ‡ callback ref<i class="fa fa-chevron-right"></i></a></div></div></footer></article><div style=""><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2022</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">RosaHong</span></div><div class="wordcount"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-chart-line"></i></span> <span>ç¸½å­—æ•¸ï¼š</span> <span title="ç¸½å­—æ•¸">289k</span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span>æ‰€éœ€ç¸½é–±è®€æ™‚é–“ &asymp;</span> <span title="æ‰€éœ€ç¸½é–±è®€æ™‚é–“">4:23</span></span></div><div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> å¼·åŠ›é©…å‹•</div></div></footer><script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1.15.0/dist/lozad.min.js"></script><script src="/js/utils.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script><script>
if (document.querySelectorAll('.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8.7.0/dist/mermaid.min.js', () => {
    mermaid.init({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    }, '.mermaid');
  }, window.mermaid);
}
</script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css"></body></html>